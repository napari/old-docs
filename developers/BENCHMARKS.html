

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>&lt;no title&gt; &mdash; napari 0.2.12+50.gff22470 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="CODE_OF_CONDUCT.html" />
    <link rel="prev" title="Developer Resources" href="../developers.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> napari
          

          
            
            <img src="../_static/napari_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.2.12+50.gff22470
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference external" href="https://napari.org">Home</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/napari/napari">Source Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">napari</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../developers.html">Developer Resources</a> &raquo;</li>
        
      <li>&lt;no title&gt;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developers/BENCHMARKS.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p># Benchmarks</p>
<p>While not mandatory for most pull requests, we ask that performance related
PRs include a benchmark in order to clearly depict the use-case that is being
optimized for. A historical view of our snapshots can be found on
at the following [website](<a class="reference external" href="https://pandas.pydata.org/speed/napari/">https://pandas.pydata.org/speed/napari/</a>).</p>
<p>In this section we will review how to setup the benchmarks,
and three commands <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">dev</span></code>, <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">run</span></code> and <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">continuous</span></code>.</p>
<p>## Prerequisites</p>
<p>Begin by installing [airspeed velocity](<a class="reference external" href="https://asv.readthedocs.io/en/stable/">https://asv.readthedocs.io/en/stable/</a>)
in your development environment. Prior to installation, be sure to activate your
development environment, then if using <code class="docutils literal notranslate"><span class="pre">venv</span></code> you may install the requirement with:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">source</span> <span class="pre">napari-dev/bin/activate</span>
<span class="pre">pip</span> <span class="pre">install</span> <span class="pre">asv</span>
<span class="pre">`</span></code>
If you are using conda, then the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">conda</span> <span class="pre">activate</span> <span class="pre">napari-dev</span>
<span class="pre">conda</span> <span class="pre">install</span> <span class="pre">asv</span>
<span class="pre">`</span></code></p>
<p>is more appropriate. Once installed, it is useful to run the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">asv</span> <span class="pre">machine</span>
<span class="pre">`</span></code></p>
<p>To let airspeed velocity know more information about your machine.</p>
<p>## Writing a benchmark</p>
<p>To write  benchmark, add a file in the <code class="docutils literal notranslate"><span class="pre">napari/_benchmarks</span></code> directory which
contains a class with one <code class="docutils literal notranslate"><span class="pre">setup</span></code> method and at least one method prefixed
with <code class="docutils literal notranslate"><span class="pre">time_</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">time_</span></code> method should only contain code you wish to benchmark.
Therefore it is useful to move everything that prepares the benchmark scenario
into the <code class="docutils literal notranslate"><span class="pre">setup</span></code> method. This function is called before calling a <code class="docutils literal notranslate"><span class="pre">time_</span></code>
method and its execution time is not factored into the benchmarks.</p>
<p>Take for example the <code class="docutils literal notranslate"><span class="pre">ViewImageSuite</span></code> benchmark:</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>python
import numpy as np
import napari
from qtpy.QtWidgets import QApplication</p>
<dl>
<dt>class ViewImageSuite:</dt><dd><p>“””Benchmarks for viewing images in the viewer.”””</p>
<dl class="simple">
<dt>def setup(self):</dt><dd><p>app = QApplication.instance() or QApplication([])
np.random.seed(0)
self.data = np.random.random((512, 512))
self.viewer = None</p>
</dd>
<dt>def teardown(self):</dt><dd><p>self.viewer.window.close()</p>
</dd>
<dt>def time_view_image(self):</dt><dd><p>“””Time to view an image.”””
self.viewer = napari.view_image(self.data)</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>Here, the creation of the image is completed in the <code class="docutils literal notranslate"><span class="pre">setup</span></code> method, and not
included in the reported time of the benchmark.</p>
<p>It is also possible to benchmark features such as peak memory usage. To learn
more about the features of <cite>asv</cite>, please refer to the official
[airspeed velocity documentation](<a class="reference external" href="http://asv.readthedocs.io/en/latest/writing_benchmarks.html">http://asv.readthedocs.io/en/latest/writing_benchmarks.html</a>).</p>
<p>## Testing the benchmarks locally</p>
<p>Prior to running the true benchmark, it is often worthwhile to test that the
code is free of typos. To do so, you may use the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">asv</span> <span class="pre">dev</span> <span class="pre">-b</span> <span class="pre">TransformSuite</span>
<span class="pre">`</span></code></p>
<p>Where the <code class="docutils literal notranslate"><span class="pre">TransformSuite</span></code> above will be run once in your current environment
to test that everything is in order.</p>
<p>## Running your benchmark</p>
<p>The command above is fast, but doesn’t test the performance of the code
adequately. To do that you may want to run the benchmark in your current
environment to see the performance of your change as you are developing new
features. The command <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">run</span> <span class="pre">-E</span> <span class="pre">existing</span></code> will specify that you wish to run
the benchmark in your existing environment. This will save a significant amount
of time since building napari can be a time consuming task:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">asv</span> <span class="pre">run</span> <span class="pre">-E</span> <span class="pre">existing</span> <span class="pre">-b</span> <span class="pre">TransformSuite</span>
<span class="pre">`</span></code></p>
<p>## Comparing results to master</p>
<p>Often, the goal of a PR is to compare the results of the modifications in terms
speed to a snapshot of the code that is in the master branch of the
<code class="docutils literal notranslate"><span class="pre">napari</span></code> repository. The command <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">continuous</span></code> is of help here:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">asv</span> <span class="pre">continuous</span> <span class="pre">master</span> <span class="pre">-b</span> <span class="pre">TransformSuite</span>
<span class="pre">`</span></code></p>
<p>This call will build out the environments specified in the <code class="docutils literal notranslate"><span class="pre">asv.conf.json</span></code>
file and compare the performance of the benchmark between your current commit
and the code in the master branch.</p>
<p>The output may look something like:</p>
<p><a href="#id9"><span class="problematic" id="id10">``</span></a>`
$ asv continuous master -b TransformSuite
· Creating environments
· Discovering benchmarks
·· Uninstalling from conda-py3.7-cython-numpy1.15-scipy
·· Installing 544c0fe3 &lt;benchmark_docs&gt; into conda-py3.7-cython-numpy1.15-scipy.
· Running 4 total benchmarks (2 commits * 2 environments * 1 benchmarks)
[  0.00%] · For napari commit 37c764cb &lt;benchmark_docs~1&gt; (round 1/2):
[…]
[100.00%] ··· …ansform.TransformSuite.time_hough_line           33.2±2ms</p>
<p>BENCHMARKS NOT SIGNIFICANTLY CHANGED.
<a href="#id11"><span class="problematic" id="id12">``</span></a>`
In this case, the differences between HEAD and master are not significant
enough for airspeed velocity to report.</p>
<p>## profiling
The airspeed velocity tool also supports code profiling using [<cite>cProfile</cite>](<a class="reference external" href="https://docs.python.org/3/library/profile.html#module-cProfile">https://docs.python.org/3/library/profile.html#module-cProfile</a>). For detailed instructions on how to use the profiling functionality see the
[asv profiling documentation](<a class="reference external" href="https://asv.readthedocs.io/en/stable/using.html#running-a-benchmark-in-the-profiler">https://asv.readthedocs.io/en/stable/using.html#running-a-benchmark-in-the-profiler</a>).</p>
<p>To profile a particular benchmark in napari you can run</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">asv</span> <span class="pre">profile</span> <span class="pre">benchmark_qt_viewer.QtViewerSuite.time_create_viewer</span> <span class="pre">-g</span> <span class="pre">snakeviz</span> <span class="pre">--python=same</span>
<span class="pre">`</span></code></p>
<p>where <cite>benchmark_qt_viewer</cite> is the file name, <cite>QtViewerSuite</cite> is the test suite class name,
and <cite>time_create_viewer</cite> is the test method.</p>
<p>To profile a particular parameterized benchmark you can run</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">asv</span> <span class="pre">profile</span> <span class="pre">&quot;benchmark_image_layer.Image2DSuite.time_create_layer\(512\)&quot;</span> <span class="pre">-g</span> <span class="pre">snakeviz</span> <span class="pre">--python=same</span>
<span class="pre">`</span></code>
where <cite>benchmark_image_layer</cite> is the file name, <cite>Image2DSuite</cite> is the test suite class name,
and <cite>time_to_create_layer</cite> is the test method and <cite>512</cite> is a valid parameter input to the test method.</p>
<p>Note that we in both these cases we have sent the output of the profiling to [snakeviz](<a class="reference external" href="http://jiffyclub.github.io/snakeviz/">http://jiffyclub.github.io/snakeviz/</a>)
which you can pip install with
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">pip</span> <span class="pre">install</span> <span class="pre">snakeviz</span>
<span class="pre">`</span></code>
and we use <cite>–python=same</cite> to profile against our current python environment.</p>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="CODE_OF_CONDUCT.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../developers.html" class="btn btn-neutral float-left" title="Developer Resources" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, napari contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>