

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Benchmarks &mdash; napari 0.2.12+94.geb46296 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Code of Conduct" href="CODE_OF_CONDUCT.html" />
    <link rel="prev" title="Developer Resources" href="../developers.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> napari
          

          
            
            <img src="../_static/napari_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.2.12+94.geb46296
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../developers.html">Developer Resources</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Benchmarks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-benchmark">Writing a benchmark</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-the-benchmarks-locally">Testing the benchmarks locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-your-benchmark">Running your benchmark</a></li>
<li class="toctree-l3"><a class="reference internal" href="#comparing-results-to-master">Comparing results to master</a></li>
<li class="toctree-l3"><a class="reference internal" href="#profiling">profiling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="CODE_OF_CONDUCT_REPORTING.html">Handling Code of Conduct Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="CONTRIBUTING.html">Contributing Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="CORE_DEV_GUIDE.html">Core Developer Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="GOVERNANCE.html">Governance Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="MISSION_AND_VALUES.html">Mission and Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="RELEASE.html">Release Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="ROADMAP_0_3.html">Roadmap</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://napari.org">Home</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/napari/napari">Source Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">napari</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../developers.html">Developer Resources</a> &raquo;</li>
        
      <li>Benchmarks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developers/BENCHMARKS.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="benchmarks">
<h1>Benchmarks<a class="headerlink" href="#benchmarks" title="Permalink to this headline">¶</a></h1>
<p>While not mandatory for most pull requests, we ask that performance related
PRs include a benchmark in order to clearly depict the use-case that is being
optimized for. A historical view of our snapshots can be found on
at the following <a class="reference external" href="https://pandas.pydata.org/speed/napari/">website</a>.</p>
<p>In this section we will review how to setup the benchmarks,
and three commands <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">dev</span></code>, <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">run</span></code> and <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">continuous</span></code>.</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>Begin by installing <a class="reference external" href="https://asv.readthedocs.io/en/stable/">airspeed velocity</a>
in your development environment. Prior to installation, be sure to activate your
development environment, then if using <code class="docutils literal notranslate"><span class="pre">venv</span></code> you may install the requirement with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> napari-dev/bin/activate
pip install asv
</pre></div>
</div>
<p>If you are using conda, then the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda activate napari-dev
conda install asv
</pre></div>
</div>
<p>is more appropriate. Once installed, it is useful to run the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>asv machine
</pre></div>
</div>
<p>To let airspeed velocity know more information about your machine.</p>
</div>
<div class="section" id="writing-a-benchmark">
<h2>Writing a benchmark<a class="headerlink" href="#writing-a-benchmark" title="Permalink to this headline">¶</a></h2>
<p>To write  benchmark, add a file in the <code class="docutils literal notranslate"><span class="pre">napari/_benchmarks</span></code> directory which
contains a class with one <code class="docutils literal notranslate"><span class="pre">setup</span></code> method and at least one method prefixed
with <code class="docutils literal notranslate"><span class="pre">time_</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">time_</span></code> method should only contain code you wish to benchmark.
Therefore it is useful to move everything that prepares the benchmark scenario
into the <code class="docutils literal notranslate"><span class="pre">setup</span></code> method. This function is called before calling a <code class="docutils literal notranslate"><span class="pre">time_</span></code>
method and its execution time is not factored into the benchmarks.</p>
<p>Take for example the <code class="docutils literal notranslate"><span class="pre">ViewImageSuite</span></code> benchmark:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">napari</span>
<span class="kn">from</span> <span class="nn">qtpy.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span>


<span class="k">class</span> <span class="nc">ViewImageSuite</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Benchmarks for viewing images in the viewer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span> <span class="ow">or</span> <span class="n">QApplication</span><span class="p">([])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">time_view_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time to view an image.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">view_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, the creation of the image is completed in the <code class="docutils literal notranslate"><span class="pre">setup</span></code> method, and not
included in the reported time of the benchmark.</p>
<p>It is also possible to benchmark features such as peak memory usage. To learn
more about the features of <code class="docutils literal notranslate"><span class="pre">asv</span></code>, please refer to the official
<a class="reference external" href="http://asv.readthedocs.io/en/latest/writing_benchmarks.html">airspeed velocity documentation</a>.</p>
</div>
<div class="section" id="testing-the-benchmarks-locally">
<h2>Testing the benchmarks locally<a class="headerlink" href="#testing-the-benchmarks-locally" title="Permalink to this headline">¶</a></h2>
<p>Prior to running the true benchmark, it is often worthwhile to test that the
code is free of typos. To do so, you may use the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>asv dev -b TransformSuite
</pre></div>
</div>
<p>Where the <code class="docutils literal notranslate"><span class="pre">TransformSuite</span></code> above will be run once in your current environment
to test that everything is in order.</p>
</div>
<div class="section" id="running-your-benchmark">
<h2>Running your benchmark<a class="headerlink" href="#running-your-benchmark" title="Permalink to this headline">¶</a></h2>
<p>The command above is fast, but doesn’t test the performance of the code
adequately. To do that you may want to run the benchmark in your current
environment to see the performance of your change as you are developing new
features. The command <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">run</span> <span class="pre">-E</span> <span class="pre">existing</span></code> will specify that you wish to run
the benchmark in your existing environment. This will save a significant amount
of time since building napari can be a time consuming task:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>asv run -E existing -b TransformSuite
</pre></div>
</div>
</div>
<div class="section" id="comparing-results-to-master">
<h2>Comparing results to master<a class="headerlink" href="#comparing-results-to-master" title="Permalink to this headline">¶</a></h2>
<p>Often, the goal of a PR is to compare the results of the modifications in terms
speed to a snapshot of the code that is in the master branch of the
<code class="docutils literal notranslate"><span class="pre">napari</span></code> repository. The command <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">continuous</span></code> is of help here:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>asv continuous master -b TransformSuite
</pre></div>
</div>
<p>This call will build out the environments specified in the <code class="docutils literal notranslate"><span class="pre">asv.conf.json</span></code>
file and compare the performance of the benchmark between your current commit
and the code in the master branch.</p>
<p>The output may look something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ asv continuous master -b TransformSuite
· Creating environments
· Discovering benchmarks
·· Uninstalling from conda-py3.7-cython-numpy1.15-scipy
·· Installing 544c0fe3 &lt;benchmark_docs&gt; into conda-py3.7-cython-numpy1.15-scipy.
· Running <span class="m">4</span> total benchmarks <span class="o">(</span><span class="m">2</span> commits * <span class="m">2</span> environments * <span class="m">1</span> benchmarks<span class="o">)</span>
<span class="o">[</span>  <span class="m">0</span>.00%<span class="o">]</span> · For napari commit 37c764cb &lt;benchmark_docs~1&gt; <span class="o">(</span>round <span class="m">1</span>/2<span class="o">)</span>:
<span class="o">[</span>...<span class="o">]</span>
<span class="o">[</span><span class="m">100</span>.00%<span class="o">]</span> ··· ...ansform.TransformSuite.time_hough_line           <span class="m">33</span>.2±2ms

BENCHMARKS NOT SIGNIFICANTLY CHANGED.
</pre></div>
</div>
<p>In this case, the differences between HEAD and master are not significant
enough for airspeed velocity to report.</p>
</div>
<div class="section" id="profiling">
<h2>profiling<a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h2>
<p>The airspeed velocity tool also supports code profiling using <a class="reference external" href="https://docs.python.org/3/library/profile.html#module-cProfile"><code class="docutils literal notranslate"><span class="pre">cProfile</span></code></a>. For detailed instructions on how to use the profiling functionality see the
<a class="reference external" href="https://asv.readthedocs.io/en/stable/using.html#running-a-benchmark-in-the-profiler">asv profiling documentation</a>.</p>
<p>To profile a particular benchmark in napari you can run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>asv profile benchmark_qt_viewer.QtViewerSuite.time_create_viewer -g snakeviz --python<span class="o">=</span>same
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">benchmark_qt_viewer</span></code> is the file name, <code class="docutils literal notranslate"><span class="pre">QtViewerSuite</span></code> is the test suite class name,
and <code class="docutils literal notranslate"><span class="pre">time_create_viewer</span></code> is the test method.</p>
<p>To profile a particular parameterized benchmark you can run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>asv profile <span class="s2">&quot;benchmark_image_layer.Image2DSuite.time_create_layer\(512\)&quot;</span> -g snakeviz --python<span class="o">=</span>same
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">benchmark_image_layer</span></code> is the file name, <code class="docutils literal notranslate"><span class="pre">Image2DSuite</span></code> is the test suite class name,
and <code class="docutils literal notranslate"><span class="pre">time_to_create_layer</span></code> is the test method and <code class="docutils literal notranslate"><span class="pre">512</span></code> is a valid parameter input to the test method.</p>
<p>Note that we in both these cases we have sent the output of the profiling to <a class="reference external" href="http://jiffyclub.github.io/snakeviz/">snakeviz</a>
which you can pip install with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install snakeviz
</pre></div>
</div>
<p>and we use <code class="docutils literal notranslate"><span class="pre">--python=same</span></code> to profile against our current python environment.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="CODE_OF_CONDUCT.html" class="btn btn-neutral float-right" title="Code of Conduct" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../developers.html" class="btn btn-neutral float-left" title="Developer Resources" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, napari contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>