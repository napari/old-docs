

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testing &mdash; napari 0.3.6.dev15+g3b92d9c documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Explanations" href="../explanations/index.html" />
    <link rel="prev" title="Roadmap" href="ROADMAP_0_3.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> napari
          

          
            
            <img src="../_static/napari_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.3.6.dev15+g3b92d9c
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../events/index.html">Events and Threading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Resources</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BENCHMARKS.html">Benchmarks</a></li>
<li class="toctree-l2"><a class="reference internal" href="CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="CODE_OF_CONDUCT_REPORTING.html">Handling Code of Conduct Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="CONTRIBUTING.html">Contributing Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="CORE_DEV_GUIDE.html">Core Developer Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="GOVERNANCE.html">Governance Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="MISSION_AND_VALUES.html">Mission and Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="RELEASE.html">Release Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="ROADMAP_0_3.html">Roadmap</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-organization">Test organization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-tests">Running Tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tips-for-speeding-up-local-testing">Tips for speeding up local testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-coverage-locally">Testing coverage locally</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-tests">Writing Tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mocking-fake-it-till-you-make-it">Mocking: “Fake it till you make it”</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#known-issues">Known Issues</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/index.html">Explanations</a></li>
<li class="toctree-l1"><a class="reference external" href="https://napari.org">Home</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/napari/napari">Source Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">napari</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developer Resources</a> &raquo;</li>
        
      <li>Testing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developers/TESTING.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing">
<h1>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>We use unit tests, integration tests, and functional tests to ensure that
<code class="docutils literal notranslate"><span class="pre">napari</span></code> works as intended. We have</p>
<ul class="simple">
<li><p>Unit tests which test if individual modules or functions work correctly
in isolation.</p></li>
<li><p>Integration tests which test if different modules or functions work properly
when combined.</p></li>
<li><p>Functional tests which test if slices of <code class="docutils literal notranslate"><span class="pre">napari</span></code> functionality work as
intended in the whole system.</p></li>
</ul>
<p>To get the most return on investment (ROI) from our coding, we strive to test as
much as we can with unit tests, requiring fewer integration tests, and the least number
of functional tests as depicted in the test pyramid below from
<a class="reference external" href="https://www.softwaretestinghelp.com/the-difference-between-unit-integration-and-functional-testing/">softwaretestinghelp.com</a>:</p>
<p><img alt="tests" src="../_images/tests.png" /></p>
<p>Unit tests are at the base of the pyramid because they are the easiest to write and
the quickest to run. The time and effort to implement and maintain tests increases
from unit tests to integration and functional tests.</p>
</div>
<div class="section" id="test-organization">
<h2>Test organization<a class="headerlink" href="#test-organization" title="Permalink to this headline">¶</a></h2>
<p>All of <code class="docutils literal notranslate"><span class="pre">napari</span></code> tests are located in folders named <code class="docutils literal notranslate"><span class="pre">_tests</span></code>. We keep our unit
tests located in the individual folders with the modules or functions they are
testing (e.g. the tests for the <code class="docutils literal notranslate"><span class="pre">Image</span></code> layer are located in a <code class="docutils literal notranslate"><span class="pre">_tests</span></code> folder
alongside the <code class="docutils literal notranslate"><span class="pre">image.py</span></code> file). Our integration and functional tests are located in
the <code class="docutils literal notranslate"><span class="pre">napari/_tests</span></code> folder at the top of the repository.</p>
<p>We also strive to unit test as much of our model file and utils code independently of
our GUI code. These tests are located in the <code class="docutils literal notranslate"><span class="pre">napari/layers</span></code>, <code class="docutils literal notranslate"><span class="pre">napari/components</span></code>,
and <code class="docutils literal notranslate"><span class="pre">napari/utils</span></code> folders. Our GUI code is tests in the <code class="docutils literal notranslate"><span class="pre">napari/_tests</span></code>,
<code class="docutils literal notranslate"><span class="pre">napari/_qt</span></code>, <code class="docutils literal notranslate"><span class="pre">napari/_vispy</span></code> folders. The <code class="docutils literal notranslate"><span class="pre">napari/plugins</span></code> folder contains a mix
of tests.</p>
</div>
<div class="section" id="running-tests">
<h2>Running Tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>To run our test suite locally, install test requirements and run pytest as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pip install -r requirements/test.txt
pytest
</pre></div>
</div>
<p>There are a very small number of tests (&lt;5) that require showing GUI elements, (such
as testing screenshots). By default, these are only run during continuous integration.
If you’d like to include them in local tests, set the environment variable “CI”:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">CI</span><span class="o">=</span><span class="m">1</span> pytest
</pre></div>
</div>
<div class="section" id="tips-for-speeding-up-local-testing">
<h3>Tips for speeding up local testing<a class="headerlink" href="#tips-for-speeding-up-local-testing" title="Permalink to this headline">¶</a></h3>
<p>Very often when developing new code, you don’t need or want to run the entire test suite (which can take many minutes to finish).  With <code class="docutils literal notranslate"><span class="pre">pytest</span></code>, it’s easy to run a subset of your tests:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># run tests in a specific subdirectory</span>
pytest napari/components
<span class="c1"># run tests in a specific file</span>
pytest napari/components/_tests/test_add_layers.py
<span class="c1"># run a specific test within a specific file</span>
pytest napari/components/_tests/test_add_layers.py::test_add_layers_with_plugins
<span class="c1"># select tests based on substring match of test name:</span>
pytest napari/layers/ -k <span class="s1">&#39;points and not bindings&#39;</span>
</pre></div>
</div>
<p>In general, it pays to learn a few of the <a class="reference external" href="https://docs.pytest.org/en/latest/example/index.html">tips and tricks</a> of running pytest.</p>
</div>
<div class="section" id="testing-coverage-locally">
<h3>Testing coverage locally<a class="headerlink" href="#testing-coverage-locally" title="Permalink to this headline">¶</a></h3>
<p>We always aim for good <a class="reference external" href="https://en.wikipedia.org/wiki/Code_coverage">test coverage</a> and we use <a class="reference external" href="https://codecov.io/gh/napari/napari">codecov</a> during continuous integration to make sure we maintain good coverage.  If you’d like to test coverage locally as you develop new code, you can install <a class="reference external" href="https://github.com/pytest-dev/pytest-cov"><code class="docutils literal notranslate"><span class="pre">pytest-cov</span></code></a> and take advantage of a few handy commands:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the full test suite with coverage</span>
pytest --cov<span class="o">=</span>napari
<span class="c1"># instead of coverage in the console, get a nice browser-based cov-report</span>
pytest --cov<span class="o">=</span>napari --cov-report<span class="o">=</span>html
open htmlcov/index.html  <span class="c1"># look at the report</span>
<span class="c1"># run a subset of tests with coverage</span>
pytest --cov<span class="o">=</span>napari.layers.shapes --cov-report<span class="o">=</span>html napari/layers/shapes
open htmlcov/index.html  <span class="c1"># look at the report</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-tests">
<h2>Writing Tests<a class="headerlink" href="#writing-tests" title="Permalink to this headline">¶</a></h2>
<p>Writing tests for new code is a critical part of keeping napari maintainable as
it grows. Tests are written in files whose names
begin with <code class="docutils literal notranslate"><span class="pre">test_*</span></code> and which are contained in one of the <code class="docutils literal notranslate"><span class="pre">_tests</span></code> directories.</p>
<p>There are a couple things to keep in mind when writing a test where a <code class="docutils literal notranslate"><span class="pre">Qt</span></code> event
loop or a <code class="docutils literal notranslate"><span class="pre">napari.Viewer</span></code> is required.  The important thing is that any widgets
you create during testing are cleaned up at the end of each test:</p>
<ol>
<li><p>If you need a <code class="docutils literal notranslate"><span class="pre">QApplication</span></code> to be running for your test, you can use the
<a class="reference external" href="https://pytest-qt.readthedocs.io/en/latest/reference.html#pytestqt.qtbot.QtBot"><code class="docutils literal notranslate"><span class="pre">qtbot</span></code></a> fixture from <code class="docutils literal notranslate"><span class="pre">pytest-qt</span></code></p>
<blockquote>
<div><p>note: fixtures in pytest can be a little mysterious, since it’s not always
clear where they are coming from.  In this case, using a pytest-qt fixture
looks like this:</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># just by putting `qtbot` in the list of arguments</span>
<span class="c1"># pytest-qt will start up an event loop for you</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">qtbot</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">qtbot</span></code> provides a convenient
<a class="reference external" href="https://pytest-qt.readthedocs.io/en/latest/reference.html#pytestqt.qtbot.QtBot.addWidget"><code class="docutils literal notranslate"><span class="pre">addWidget</span></code></a>
method that will ensure that the widget gets closed at the end of the test.
It <em>also</em> provides a whole bunch of other
convenient methods for interacting with your GUI tests (clicking, waiting
signals, etc…).  See the <a class="reference external" href="https://pytest-qt.readthedocs.io/en/latest/reference.html#pytestqt.qtbot.QtBot"><code class="docutils literal notranslate"><span class="pre">qtbot</span></code> docs</a> for details.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the qtbot provides convenience methods like addWidget</span>
<span class="k">def</span> <span class="nf">test_something_else</span><span class="p">(</span><span class="n">qtbot</span><span class="p">):</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
    <span class="n">qtbot</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>  <span class="c1"># tell qtbot to clean this widget later</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p>When writing a test that requires a <code class="docutils literal notranslate"><span class="pre">napari.Viewer</span></code> object, we provide our
own convenient fixture called <code class="docutils literal notranslate"><span class="pre">make_test_viewer</span></code> that will take care of
creating a viewer and cleaning up at the end of the test.  When using this
function, it is <strong>not</strong> necessary to use a <code class="docutils literal notranslate"><span class="pre">qtbot</span></code> fixture, nor should you do
any additional cleanup (such as using <code class="docutils literal notranslate"><span class="pre">qtbot.addWidget</span></code> or calling
<code class="docutils literal notranslate"><span class="pre">viewer.close()</span></code>) at the end of the test.  Duplicate cleanup may cause an
error.  Use the fixture as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the make_test_viewer fixture is defined in napari/conftest.py</span>
<span class="k">def</span> <span class="nf">test_something_with_a_viewer</span><span class="p">(</span><span class="n">make_test_viewer</span><span class="p">):</span>
    <span class="c1"># make_test_viewer takes any keyword arguments that napari.Viewer() takes</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">make_test_viewer</span><span class="p">()</span>

    <span class="c1"># do stuff with the viewer, no qtbot or viewer.close() methods needed.</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>If you’re curious to see the actual <code class="docutils literal notranslate"><span class="pre">make_test_viewer</span></code> fixture definition, it’s
in <code class="docutils literal notranslate"><span class="pre">napari/conftest.py</span></code></p>
</div></blockquote>
<div class="section" id="mocking-fake-it-till-you-make-it">
<h3>Mocking: “Fake it till you make it”<a class="headerlink" href="#mocking-fake-it-till-you-make-it" title="Permalink to this headline">¶</a></h3>
<p>It can be confusing to write unit tests for individual functions, when the
function being tested in turn depends on the output from some other function or
method.  This makes it tempting to write integration tests that “just test the
whole thing together”.  A useful tool in this case is the <a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html">mock object
library</a>.  “Mocking” lets
you patch or replace parts of the code being tested with “fake” behavior or
return values, so that you can test how a given function would perform <em>if</em> it
were to receive some value from the upstream code.  For a few examples of using
mocks when testing napari, search the codebase for
<a class="reference external" href="https://github.com/napari/napari/search?q=%22unittest.mock%22&amp;type=Code"><code class="docutils literal notranslate"><span class="pre">unittest.mock</span></code></a></p>
</div>
</div>
<div class="section" id="known-issues">
<h2>Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this headline">¶</a></h2>
<p>There are several known issues with displaying GUI tests on windows in CI, and
so certain tests have been disabled from windows in CI, see
<a class="reference external" href="https://github.com/napari/napari/pull/1377">#1377</a> for more discussion.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../explanations/index.html" class="btn btn-neutral float-right" title="Explanations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ROADMAP_0_3.html" class="btn btn-neutral float-left" title="Roadmap" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, napari contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>