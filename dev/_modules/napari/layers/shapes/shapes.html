

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>napari.layers.shapes.shapes &mdash; napari 0.4.3.dev15+g86f9649 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <script async defer data-domain="napari.org" src="https://plausible.io/js/plausible.js"></script>
     

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> napari
          

          
            
            <img src="../../../../_static/napari_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.4.3.dev15+g86f9649
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../events/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developers/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../explanations/index.html">Explanations</a></li>
<li class="toctree-l1"><a class="reference external" href="https://napari.org">Home</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/napari/napari">Source Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">napari</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>napari.layers.shapes.shapes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for napari.layers.shapes.shapes</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">vispy.color</span> <span class="kn">import</span> <span class="n">get_color_names</span>

<span class="kn">from</span> <span class="nn">...utils.colormaps</span> <span class="kn">import</span> <span class="n">Colormap</span><span class="p">,</span> <span class="n">ValidColormapArg</span><span class="p">,</span> <span class="n">ensure_colormap</span>
<span class="kn">from</span> <span class="nn">...utils.colormaps.standardize_color</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">hex_to_name</span><span class="p">,</span>
    <span class="n">rgb_to_hex</span><span class="p">,</span>
    <span class="n">transform_color</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">...utils.events</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">...utils.misc</span> <span class="kn">import</span> <span class="n">ensure_iterable</span>
<span class="kn">from</span> <span class="nn">...utils.status_messages</span> <span class="kn">import</span> <span class="n">format_float</span>
<span class="kn">from</span> <span class="nn">..base</span> <span class="kn">import</span> <span class="n">Layer</span>
<span class="kn">from</span> <span class="nn">..utils.color_transformations</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ColorType</span><span class="p">,</span>
    <span class="n">normalize_and_broadcast_colors</span><span class="p">,</span>
    <span class="n">transform_color_cycle</span><span class="p">,</span>
    <span class="n">transform_color_with_defaults</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..utils.layer_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">dataframe_to_properties</span><span class="p">,</span>
    <span class="n">guess_continuous</span><span class="p">,</span>
    <span class="n">map_property</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..utils.text</span> <span class="kn">import</span> <span class="n">TextManager</span>
<span class="kn">from</span> <span class="nn">._shape_list</span> <span class="kn">import</span> <span class="n">ShapeList</span>
<span class="kn">from</span> <span class="nn">._shapes_constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BACKSPACE</span><span class="p">,</span>
    <span class="n">Box</span><span class="p">,</span>
    <span class="n">ColorMode</span><span class="p">,</span>
    <span class="n">Mode</span><span class="p">,</span>
    <span class="n">ShapeType</span><span class="p">,</span>
    <span class="n">shape_classes</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">._shapes_models</span> <span class="kn">import</span> <span class="n">Ellipse</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">._shapes_mouse_bindings</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">add_ellipse</span><span class="p">,</span>
    <span class="n">add_line</span><span class="p">,</span>
    <span class="n">add_path_polygon</span><span class="p">,</span>
    <span class="n">add_path_polygon_creating</span><span class="p">,</span>
    <span class="n">add_rectangle</span><span class="p">,</span>
    <span class="n">highlight</span><span class="p">,</span>
    <span class="n">select</span><span class="p">,</span>
    <span class="n">vertex_insert</span><span class="p">,</span>
    <span class="n">vertex_remove</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">._shapes_utils</span> <span class="kn">import</span> <span class="n">create_box</span><span class="p">,</span> <span class="n">get_shape_ndim</span><span class="p">,</span> <span class="n">number_of_shapes</span>

<span class="n">DEFAULT_COLOR_CYCLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>


<div class="viewcode-block" id="Shapes"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes">[docs]</a><span class="k">class</span> <span class="nc">Shapes</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shapes layer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : list or array</span>
<span class="sd">        List of shape data, where each element is an (N, D) array of the</span>
<span class="sd">        N vertices of a shape in D dimensions. Can be an 3-dimensional</span>
<span class="sd">        array if each shape has the same number of vertices.</span>
<span class="sd">    ndim : int</span>
<span class="sd">        Number of dimensions for shapes. When data is not None, ndim must be D.</span>
<span class="sd">        An empty shapes layer can be instantiated with arbitrary ndim.</span>
<span class="sd">    properties : dict {str: array (N,)}, DataFrame</span>
<span class="sd">        Properties for each shape. Each property should be an array of length N,</span>
<span class="sd">        where N is the number of shapes.</span>
<span class="sd">    text : str, dict</span>
<span class="sd">        Text to be displayed with the shapes. If text is set to a key in properties,</span>
<span class="sd">        the value of that property will be displayed. Multiple properties can be</span>
<span class="sd">        composed using f-string-like syntax (e.g., &#39;{property_1}, {float_property:.2f}).</span>
<span class="sd">        A dictionary can be provided with keyword arguments to set the text values</span>
<span class="sd">        and display properties. See TextManager.__init__() for the valid keyword arguments.</span>
<span class="sd">        For example usage, see /napari/examples/add_shapes_with_text.py.</span>
<span class="sd">    shape_type : string or list</span>
<span class="sd">        String of shape shape_type, must be one of &quot;{&#39;line&#39;, &#39;rectangle&#39;,</span>
<span class="sd">        &#39;ellipse&#39;, &#39;path&#39;, &#39;polygon&#39;}&quot;. If a list is supplied it must be</span>
<span class="sd">        the same length as the length of `data` and each element will be</span>
<span class="sd">        applied to each shape otherwise the same value will be used for all</span>
<span class="sd">        shapes.</span>
<span class="sd">    edge_width : float or list</span>
<span class="sd">        Thickness of lines and edges. If a list is supplied it must be the</span>
<span class="sd">        same length as the length of `data` and each element will be</span>
<span class="sd">        applied to each shape otherwise the same value will be used for all</span>
<span class="sd">        shapes.</span>
<span class="sd">    edge_color : str, array-like</span>
<span class="sd">        If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">        starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">        or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">        the length of `data` and each element will be applied to each shape</span>
<span class="sd">        otherwise the same value will be used for all shapes.</span>
<span class="sd">    edge_color_cycle : np.ndarray, list</span>
<span class="sd">        Cycle of colors (provided as string name, RGB, or RGBA) to map to edge_color if a</span>
<span class="sd">        categorical attribute is used color the vectors.</span>
<span class="sd">    edge_colormap : str, napari.utils.Colormap</span>
<span class="sd">        Colormap to set edge_color if a continuous attribute is used to set face_color.</span>
<span class="sd">    edge_contrast_limits : None, (float, float)</span>
<span class="sd">        clims for mapping the property to a color map. These are the min and max value</span>
<span class="sd">        of the specified property that are mapped to 0 and 1, respectively.</span>
<span class="sd">        The default value is None. If set the none, the clims will be set to</span>
<span class="sd">        (property.min(), property.max())</span>
<span class="sd">    face_color : str, array-like</span>
<span class="sd">        If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">        starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">        or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">        the length of `data` and each element will be applied to each shape</span>
<span class="sd">        otherwise the same value will be used for all shapes.</span>
<span class="sd">    face_color_cycle : np.ndarray, list</span>
<span class="sd">        Cycle of colors (provided as string name, RGB, or RGBA) to map to face_color if a</span>
<span class="sd">        categorical attribute is used color the vectors.</span>
<span class="sd">    face_colormap : str, napari.utils.Colormap</span>
<span class="sd">        Colormap to set face_color if a continuous attribute is used to set face_color.</span>
<span class="sd">    face_contrast_limits : None, (float, float)</span>
<span class="sd">        clims for mapping the property to a color map. These are the min and max value</span>
<span class="sd">        of the specified property that are mapped to 0 and 1, respectively.</span>
<span class="sd">        The default value is None. If set the none, the clims will be set to</span>
<span class="sd">        (property.min(), property.max())</span>
<span class="sd">    z_index : int or list</span>
<span class="sd">        Specifier of z order priority. Shapes with higher z order are</span>
<span class="sd">        displayed ontop of others. If a list is supplied it must be the</span>
<span class="sd">        same length as the length of `data` and each element will be</span>
<span class="sd">        applied to each shape otherwise the same value will be used for all</span>
<span class="sd">        shapes.</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the layer.</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        Layer metadata.</span>
<span class="sd">    scale : tuple of float</span>
<span class="sd">        Scale factors for the layer.</span>
<span class="sd">    translate : tuple of float</span>
<span class="sd">        Translation values for the layer.</span>
<span class="sd">    rotate : float, 3-tuple of float, or n-D array.</span>
<span class="sd">        If a float convert into a 2D rotation matrix using that value as an</span>
<span class="sd">        angle. If 3-tuple convert into a 3D rotation matrix, using a yaw,</span>
<span class="sd">        pitch, roll convention. Otherwise assume an nD rotation. Angles are</span>
<span class="sd">        assumed to be in degrees. They can be converted from radians with</span>
<span class="sd">        np.degrees if needed.</span>
<span class="sd">    shear : 1-D array or n-D array</span>
<span class="sd">        Either a vector of upper triangular values, or an nD shear matrix with</span>
<span class="sd">        ones along the main diagonal.</span>
<span class="sd">    affine: n-D array or napari.utils.transforms.Affine</span>
<span class="sd">        (N+1, N+1) affine transformation matrix in homogeneous coordinates.</span>
<span class="sd">        The first (N, N) entries correspond to a linear transform and</span>
<span class="sd">        the final column is a lenght N translation vector and a 1 or a napari</span>
<span class="sd">        AffineTransform object. If provided then translate, scale, rotate, and</span>
<span class="sd">        shear values are ignored.</span>
<span class="sd">    opacity : float</span>
<span class="sd">        Opacity of the layer visual, between 0.0 and 1.0.</span>
<span class="sd">    blending : str</span>
<span class="sd">        One of a list of preset blending modes that determines how RGB and</span>
<span class="sd">        alpha values of the layer visual get mixed. Allowed values are</span>
<span class="sd">        {&#39;opaque&#39;, &#39;translucent&#39;, and &#39;additive&#39;}.</span>
<span class="sd">    visible : bool</span>
<span class="sd">        Whether the layer visual is currently being displayed.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : (N, ) list of array</span>
<span class="sd">        List of shape data, where each element is an (N, D) array of the</span>
<span class="sd">        N vertices of a shape in D dimensions.</span>
<span class="sd">    properties : dict {str: array (N,)}, DataFrame</span>
<span class="sd">        Properties for each shape. Each property should be an array of length N,</span>
<span class="sd">        where N is the number of shapes.</span>
<span class="sd">    text : str, dict</span>
<span class="sd">        Text to be displayed with the shapes. If text is set to a key in properties,</span>
<span class="sd">        the value of that property will be displayed. Multiple properties can be</span>
<span class="sd">        composed using f-string-like syntax (e.g., &#39;{property_1}, {float_property:.2f}).</span>
<span class="sd">        For example usage, see /napari/examples/add_shapes_with_text.py.</span>
<span class="sd">    shape_type : (N, ) list of str</span>
<span class="sd">        Name of shape type for each shape.</span>
<span class="sd">    edge_color : str, array-like</span>
<span class="sd">        Color of the shape border. Numeric color values should be RGB(A).</span>
<span class="sd">    face_color : str, array-like</span>
<span class="sd">        Color of the shape face. Numeric color values should be RGB(A).</span>
<span class="sd">    edge_width : (N, ) list of float</span>
<span class="sd">        Edge width for each shape.</span>
<span class="sd">    z_index : (N, ) list of int</span>
<span class="sd">        z-index for each shape.</span>
<span class="sd">    current_edge_width : float</span>
<span class="sd">        Thickness of lines and edges of the next shape to be added or the</span>
<span class="sd">        currently selected shape.</span>
<span class="sd">    current_edge_color : str</span>
<span class="sd">        Color of the edge of the next shape to be added or the currently</span>
<span class="sd">        selected shape.</span>
<span class="sd">    current_face_color : str</span>
<span class="sd">        Color of the face of the next shape to be added or the currently</span>
<span class="sd">        selected shape.</span>
<span class="sd">    selected_data : set</span>
<span class="sd">        List of currently selected shapes.</span>
<span class="sd">    nshapes : int</span>
<span class="sd">        Total number of shapes.</span>
<span class="sd">    mode : Mode</span>
<span class="sd">        Interactive mode. The normal, default mode is PAN_ZOOM, which</span>
<span class="sd">        allows for normal interactivity with the canvas.</span>

<span class="sd">        The SELECT mode allows for entire shapes to be selected, moved and</span>
<span class="sd">        resized.</span>

<span class="sd">        The DIRECT mode allows for shapes to be selected and their individual</span>
<span class="sd">        vertices to be moved.</span>

<span class="sd">        The VERTEX_INSERT and VERTEX_REMOVE modes allow for individual</span>
<span class="sd">        vertices either to be added to or removed from shapes that are already</span>
<span class="sd">        selected. Note that shapes cannot be selected in this mode.</span>

<span class="sd">        The ADD_RECTANGLE, ADD_ELLIPSE, ADD_LINE, ADD_PATH, and ADD_POLYGON</span>
<span class="sd">        modes all allow for their corresponding shape type to be added.</span>

<span class="sd">    Extended Summary</span>
<span class="sd">    ----------</span>
<span class="sd">    _data_dict : Dict of ShapeList</span>
<span class="sd">        Dictionary containing all the shape data indexed by slice tuple</span>
<span class="sd">    _data_view : ShapeList</span>
<span class="sd">        Object containing the currently viewed shape data.</span>
<span class="sd">    _mode_history : Mode</span>
<span class="sd">        Interactive mode captured on press of &lt;space&gt;.</span>
<span class="sd">    _selected_data_history : set</span>
<span class="sd">        Set of currently selected captured on press of &lt;space&gt;.</span>
<span class="sd">    _selected_data_stored : set</span>
<span class="sd">        Set of selected previously displayed. Used to prevent rerendering the</span>
<span class="sd">        same highlighted shapes when no data has changed.</span>
<span class="sd">    _selected_box : None | np.ndarray</span>
<span class="sd">        `None` if no shapes are selected, otherwise a 10x2 array of vertices of</span>
<span class="sd">        the interaction box. The first 8 points are the corners and midpoints</span>
<span class="sd">        of the box. The 9th point is the center of the box, and the last point</span>
<span class="sd">        is the location of the rotation handle that can be used to rotate the</span>
<span class="sd">        box.</span>
<span class="sd">    _drag_start : None | np.ndarray</span>
<span class="sd">        If a drag has been started and is in progress then a length 2 array of</span>
<span class="sd">        the initial coordinates of the drag. `None` otherwise.</span>
<span class="sd">    _drag_box : None | np.ndarray</span>
<span class="sd">        If a drag box is being created to select shapes then this is a 2x2</span>
<span class="sd">        array of the two extreme corners of the drag. `None` otherwise.</span>
<span class="sd">    _drag_box_stored : None | np.ndarray</span>
<span class="sd">        If a drag box is being created to select shapes then this is a 2x2</span>
<span class="sd">        array of the two extreme corners of the drag that have previously been</span>
<span class="sd">        rendered. `None` otherwise. Used to prevent rerendering the same</span>
<span class="sd">        drag box when no data has changed.</span>
<span class="sd">    _is_moving : bool</span>
<span class="sd">        Bool indicating if any shapes are currently being moved.</span>
<span class="sd">    _is_selecting : bool</span>
<span class="sd">        Bool indicating if a drag box is currently being created in order to</span>
<span class="sd">        select shapes.</span>
<span class="sd">    _is_creating : bool</span>
<span class="sd">        Bool indicating if any shapes are currently being created.</span>
<span class="sd">    _fixed_aspect : bool</span>
<span class="sd">        Bool indicating if aspect ratio of shapes should be preserved on</span>
<span class="sd">        resizing.</span>
<span class="sd">    _aspect_ratio : float</span>
<span class="sd">        Value of aspect ratio to be preserved if `_fixed_aspect` is `True`.</span>
<span class="sd">    _fixed_vertex : None | np.ndarray</span>
<span class="sd">        If a scaling or rotation is in progress then a length 2 array of the</span>
<span class="sd">        coordinates that are remaining fixed during the move. `None` otherwise.</span>
<span class="sd">    _fixed_index : int</span>
<span class="sd">        If a scaling or rotation is in progress then the index of the vertex of</span>
<span class="sd">        the boudning box that is remaining fixed during the move. `None`</span>
<span class="sd">        otherwise.</span>
<span class="sd">    _update_properties : bool</span>
<span class="sd">        Bool indicating if properties are to allowed to update the selected</span>
<span class="sd">        shapes when they are changed. Blocking this prevents circular loops</span>
<span class="sd">        when shapes are selected and the properties are changed based on that</span>
<span class="sd">        selection</span>
<span class="sd">    _allow_thumnail_update : bool</span>
<span class="sd">        Flag set to true to allow the thumbnail to be updated. Blocking the thumbnail</span>
<span class="sd">        can be advantageous where responsiveness is critical.</span>
<span class="sd">    _clipboard : dict</span>
<span class="sd">        Dict of shape objects that are to be used during a copy and paste.</span>
<span class="sd">    _colors : list</span>
<span class="sd">        List of supported vispy color names.</span>
<span class="sd">    _vertex_size : float</span>
<span class="sd">        Size of the vertices of the shapes and bounding box in Canvas</span>
<span class="sd">        coordinates.</span>
<span class="sd">    _rotation_handle_length : float</span>
<span class="sd">        Length of the rotation handle of the boudning box in Canvas</span>
<span class="sd">        coordinates.</span>
<span class="sd">    _input_ndim : int</span>
<span class="sd">        Dimensions of shape data.</span>
<span class="sd">    _thumbnail_update_thresh : int</span>
<span class="sd">        If there are more than this number of shapes, the thumnail</span>
<span class="sd">        won&#39;t update during interactive events</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_colors</span> <span class="o">=</span> <span class="n">get_color_names</span><span class="p">()</span>
    <span class="n">_vertex_size</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">_rotation_handle_length</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">_highlight_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_highlight_width</span> <span class="o">=</span> <span class="mf">1.5</span>

    <span class="c1"># If more shapes are present then they are randomly subsampled</span>
    <span class="c1"># in the thumbnail</span>
    <span class="n">_max_shapes_thumbnail</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">ndim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shape_type</span><span class="o">=</span><span class="s1">&#39;rectangle&#39;</span><span class="p">,</span>
        <span class="n">edge_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">edge_color_cycle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_colormap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
        <span class="n">edge_contrast_limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">face_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
        <span class="n">face_color_cycle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">face_colormap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
        <span class="n">face_contrast_limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">z_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">translate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rotate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">affine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">blending</span><span class="o">=</span><span class="s1">&#39;translucent&#39;</span><span class="p">,</span>
        <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_ndim</span> <span class="o">=</span> <span class="n">get_shape_ndim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="n">data_ndim</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape dimensions must be equal to ndim&quot;</span><span class="p">)</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="n">data_ndim</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">translate</span><span class="o">=</span><span class="n">translate</span><span class="p">,</span>
            <span class="n">rotate</span><span class="o">=</span><span class="n">rotate</span><span class="p">,</span>
            <span class="n">shear</span><span class="o">=</span><span class="n">shear</span><span class="p">,</span>
            <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
            <span class="n">blending</span><span class="o">=</span><span class="n">blending</span><span class="p">,</span>
            <span class="n">visible</span><span class="o">=</span><span class="n">visible</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">edge_width</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">edge_color</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">face_color</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">current_edge_color</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">current_face_color</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">current_properties</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
            <span class="n">highlight</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Flag set to false to block thumbnail refresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_thumbnail_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_display_order_stored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay_stored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span>

        <span class="c1"># Save the properties</span>
        <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_property_choices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">properties</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dataframe_to_properties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_property_choices</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_property_choices</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">empty_properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_property_choices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">empty_properties</span>

        <span class="c1"># make the text</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">TextManager</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">copied_text</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">copied_text</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
            <span class="n">copied_text</span><span class="p">[</span><span class="s1">&#39;n_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">TextManager</span><span class="p">(</span><span class="o">**</span><span class="n">copied_text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;text should be a string, array, or dict&#39;</span><span class="p">)</span>

        <span class="c1"># The following shape properties are for the new shapes that will</span>
        <span class="c1"># be drawn. Each shape has a corresponding property with the</span>
        <span class="c1"># value for itself</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">edge_width</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_width</span> <span class="o">=</span> <span class="n">edge_width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_width</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span> <span class="o">=</span> <span class="n">ShapeList</span><span class="p">(</span><span class="n">ndisplay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">slice_key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slice_indices</span><span class="p">)[</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims_not_displayed</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value_stored</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moving_value</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data_stored</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data_history</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_aspect</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aspect_ratio</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_moving</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_selecting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box_stored</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_creating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="o">.</span><span class="n">PAN_ZOOM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_help</span> <span class="o">=</span> <span class="s1">&#39;enter a selection mode to edit shape properties&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_shapes</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">shape_type</span><span class="o">=</span><span class="n">shape_type</span><span class="p">,</span>
            <span class="n">edge_width</span><span class="o">=</span><span class="n">edge_width</span><span class="p">,</span>
            <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
            <span class="n">edge_color_cycle</span><span class="o">=</span><span class="n">edge_color_cycle</span><span class="p">,</span>
            <span class="n">edge_colormap</span><span class="o">=</span><span class="n">edge_colormap</span><span class="p">,</span>
            <span class="n">edge_contrast_limits</span><span class="o">=</span><span class="n">edge_contrast_limits</span><span class="p">,</span>
            <span class="n">face_color</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
            <span class="n">face_color_cycle</span><span class="o">=</span><span class="n">face_color_cycle</span><span class="p">,</span>
            <span class="n">face_colormap</span><span class="o">=</span><span class="n">face_colormap</span><span class="p">,</span>
            <span class="n">face_contrast_limits</span><span class="o">=</span><span class="n">face_contrast_limits</span><span class="p">,</span>
            <span class="n">z_index</span><span class="o">=</span><span class="n">z_index</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># set the current_* properties</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_color</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_face_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_color</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_property_choices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_current_color_for_empty_layer</span><span class="p">(</span><span class="n">edge_color</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_current_color_for_empty_layer</span><span class="p">(</span><span class="n">face_color</span><span class="p">,</span> <span class="s1">&#39;face&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_color</span> <span class="o">=</span> <span class="n">transform_color_with_defaults</span><span class="p">(</span>
                <span class="n">num_entries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                <span class="n">elem_name</span><span class="o">=</span><span class="s2">&quot;edge_color&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_face_color</span> <span class="o">=</span> <span class="n">transform_color_with_defaults</span><span class="p">(</span>
                <span class="n">num_entries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                <span class="n">elem_name</span><span class="o">=</span><span class="s2">&quot;face_color&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Trigger generation of view slice and thumbnail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dims</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_initialize_current_color_for_empty_layer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">ColorType</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize current_{edge,face}_color when starting with empty layer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color : (N, 4) array or str</span>
<span class="sd">            The value for setting edge or face_color</span>
<span class="sd">        attribute : str in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_color or &#39;face&#39; for face_color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">color_mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">:</span>
            <span class="n">curr_color</span> <span class="o">=</span> <span class="n">transform_color_with_defaults</span><span class="p">(</span>
                <span class="n">num_entries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">elem_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color&#39;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">:</span>
            <span class="n">color_cycle</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle&#39;</span><span class="p">)</span>
            <span class="n">curr_color</span> <span class="o">=</span> <span class="n">transform_color</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">))</span>

            <span class="c1"># add the new color cycle mapping</span>
            <span class="n">color_property</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="n">prop_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_property_choices</span><span class="p">[</span><span class="n">color_property</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">color_cycle_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_map&#39;</span><span class="p">)</span>
            <span class="n">color_cycle_map</span><span class="p">[</span><span class="n">prop_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">curr_color</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_map&#39;</span><span class="p">,</span> <span class="n">color_cycle_map</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">:</span>
            <span class="n">color_property</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="n">prop_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_property_choices</span><span class="p">[</span><span class="n">color_property</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_colormap&#39;</span><span class="p">)</span>
            <span class="n">contrast_limits</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_contrast_limits&#39;</span><span class="p">)</span>
            <span class="n">curr_color</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_property</span><span class="p">(</span>
                <span class="n">prop</span><span class="o">=</span><span class="n">prop_value</span><span class="p">,</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
                <span class="n">contrast_limits</span><span class="o">=</span><span class="n">contrast_limits</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_current_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color&#39;</span><span class="p">,</span> <span class="n">curr_color</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list: Each element is an (N, D) array of the vertices of a shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">shape_type</span><span class="o">=</span><span class="s1">&#39;rectangle&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finish_drawing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span> <span class="o">=</span> <span class="n">ShapeList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape_type</span><span class="o">=</span><span class="n">shape_type</span><span class="p">)</span>

        <span class="n">n_new_shapes</span> <span class="o">=</span> <span class="n">number_of_shapes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span><span class="p">,</span> <span class="n">n_new_shapes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dims</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_editable</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;bool: Whether this layer is selected or not.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected</span>

    <span class="nd">@selected</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">selected</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected</span> <span class="o">=</span> <span class="n">selected</span>

        <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">deselect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finish_drawing</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;dict {str: np.ndarray (N,)}, DataFrame: Annotations for each shape&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>

    <span class="nd">@properties</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">properties</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dataframe_to_properties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_face_color_property</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_face_color_property</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_face_color_property</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;property used for face_color dropped&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_color_property</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edge_color_property</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edge_color_property</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;property used for edge_color dropped&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_text</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine number of dimensions of the layer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nshapes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ndim</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_extent_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Extent of layer in data coordinates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        extent_data : array, shape (2, D)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">extrema</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">extrema</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">mins</span><span class="p">,</span> <span class="n">maxs</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">extrema</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nshapes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;int: Total number of shapes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shapes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_edge_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;float: Width of shape edges including lines and paths.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_width</span>

    <span class="nd">@current_edge_width</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_edge_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_width</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_width</span> <span class="o">=</span> <span class="n">edge_width</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_properties</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">update_edge_width</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">edge_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">format_float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_edge_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">edge_width</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_edge_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: color of shape edges including lines and paths.&quot;&quot;&quot;</span>
        <span class="n">hex_</span> <span class="o">=</span> <span class="n">rgb_to_hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_color</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">hex_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hex_</span><span class="p">,</span> <span class="n">hex_</span><span class="p">)</span>

    <span class="nd">@current_edge_color</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_edge_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_color</span> <span class="o">=</span> <span class="n">transform_color</span><span class="p">(</span><span class="n">edge_color</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_properties</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">update_edge_color</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_color</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">edge_color</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_thumbnail</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current_edge_color</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_face_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str: color of shape faces.&quot;&quot;&quot;</span>
        <span class="n">hex_</span> <span class="o">=</span> <span class="n">rgb_to_hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_face_color</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">hex_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hex_</span><span class="p">,</span> <span class="n">hex_</span><span class="p">)</span>

    <span class="nd">@current_face_color</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_face_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_face_color</span> <span class="o">=</span> <span class="n">transform_color</span><span class="p">(</span><span class="n">face_color</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_properties</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">update_face_color</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_face_color</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">face_color</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_thumbnail</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current_face_color</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;dict{str: np.ndarray(1,)}: properties for the next added shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_properties</span>

    <span class="nd">@current_properties</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_properties</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_properties</span> <span class="o">=</span> <span class="n">current_properties</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_properties</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">PAN_ZOOM</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
                <span class="n">props</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)]</span> <span class="o">=</span> <span class="n">current_properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">props</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_colors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current_properties</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list of str: name of shape type for each shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shape_types</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(N x 4) np.ndarray: Array of RGBA face colors for each shape&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">edge_color</span>

    <span class="nd">@edge_color</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">edge_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color</span><span class="p">(</span><span class="n">edge_color</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">edge_color</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_thumbnail</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge_color_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Union[list, np.ndarray] :  Color cycle for edge_color.</span>

<span class="sd">        Can be a list of colors defined by name, RGB or RGBA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_color_cycle_values</span>

    <span class="nd">@edge_color_cycle</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">edge_color_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_color_cycle</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color_cycle</span><span class="p">(</span><span class="n">edge_color_cycle</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Colormap</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the colormap to be applied to a property to get the edge color.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        colormap : napari.utils.Colormap</span>
<span class="sd">            The Colormap object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_colormap</span>

    <span class="nd">@edge_colormap</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">edge_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colormap</span><span class="p">:</span> <span class="n">ValidColormapArg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_colormap</span> <span class="o">=</span> <span class="n">ensure_colormap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge_contrast_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot; None, (float, float): contrast limits for mapping</span>
<span class="sd">        the edge_color colormap property to 0 and 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_contrast_limits</span>

    <span class="nd">@edge_contrast_limits</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">edge_contrast_limits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">contrast_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_contrast_limits</span> <span class="o">=</span> <span class="n">contrast_limits</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge_color_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;str: Edge color setting mode</span>

<span class="sd">        DIRECT (default mode) allows each shape color to be set arbitrarily</span>

<span class="sd">        CYCLE allows the color to be set via a color cycle over an attribute</span>

<span class="sd">        COLORMAP allows color to be set via a color map over an attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_color_mode</span><span class="p">)</span>

    <span class="nd">@edge_color_mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">edge_color_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_color_mode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ColorMode</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color_mode</span><span class="p">(</span><span class="n">edge_color_mode</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">face_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(N x 4) np.ndarray: Array of RGBA face colors for each shape&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">face_color</span>

    <span class="nd">@face_color</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">face_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color</span><span class="p">(</span><span class="n">face_color</span><span class="p">,</span> <span class="s1">&#39;face&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">face_color</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_thumbnail</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">face_color_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Union[np.ndarray, cycle]:  Color cycle for face_color</span>
<span class="sd">        Can be a list of colors defined by name, RGB or RGBA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_face_color_cycle_values</span>

    <span class="nd">@face_color_cycle</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">face_color_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_color_cycle</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cycle</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color_cycle</span><span class="p">(</span><span class="n">face_color_cycle</span><span class="p">,</span> <span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">face_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Colormap</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return the colormap to be applied to a property to get the face color.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        colormap : napari.utils.Colormap</span>
<span class="sd">            The Colormap object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_face_colormap</span>

    <span class="nd">@face_colormap</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">face_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colormap</span><span class="p">:</span> <span class="n">ValidColormapArg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_face_colormap</span> <span class="o">=</span> <span class="n">ensure_colormap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">face_contrast_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;None, (float, float) : clims for mapping the face_color</span>
<span class="sd">        colormap property to 0 and 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_face_contrast_limits</span>

    <span class="nd">@face_contrast_limits</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">face_contrast_limits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">contrast_limits</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_face_contrast_limits</span> <span class="o">=</span> <span class="n">contrast_limits</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">face_color_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;str: Face color setting mode</span>

<span class="sd">        DIRECT (default mode) allows each shape color to be set arbitrarily</span>

<span class="sd">        CYCLE allows the color to be set via a color cycle over an attribute</span>

<span class="sd">        COLORMAP allows color to be set via a color map over an attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_face_color_mode</span><span class="p">)</span>

    <span class="nd">@face_color_mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">face_color_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_color_mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color_mode</span><span class="p">(</span><span class="n">face_color_mode</span><span class="p">,</span> <span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_color_mode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">color_mode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ColorMode</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the face_color_mode or edge_color_mode property</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color_mode : str, ColorMode</span>
<span class="sd">            The value for setting edge or face_color_mode. If color_mode is a string,</span>
<span class="sd">            it should be one of: &#39;direct&#39;, &#39;cycle&#39;, or &#39;colormap&#39;</span>
<span class="sd">        attribute : str in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_colo_moder or &#39;face&#39; for face_color_mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">color_mode</span> <span class="o">=</span> <span class="n">ColorMode</span><span class="p">(</span><span class="n">color_mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">color_mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">color_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">):</span>
            <span class="n">color_property</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color_property</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                    <span class="n">new_color_property</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">,</span>
                        <span class="n">new_color_property</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property was not set, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;setting to: </span><span class="si">{</span><span class="n">new_color_property</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;There must be a valid Shapes.properties to use &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_mode</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>

            <span class="c1"># ColorMode.COLORMAP can only be applied to numeric properties</span>
            <span class="n">color_property</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">color_property</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s1">&#39;selected property must be numeric to use ColorMode.COLORMAP&#39;</span>
                <span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">color_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_colors</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_color_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color_cycle</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the face_color_cycle or edge_color_cycle property</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color_cycle : (N, 4) or (N, 1) array</span>
<span class="sd">            The value for setting edge or face_color_cycle</span>
<span class="sd">        attribute : str in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_color or &#39;face&#39; for face_color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transformed_color_cycle</span><span class="p">,</span> <span class="n">transformed_colors</span> <span class="o">=</span> <span class="n">transform_color_cycle</span><span class="p">(</span>
            <span class="n">color_cycle</span><span class="o">=</span><span class="n">color_cycle</span><span class="p">,</span>
            <span class="n">elem_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_values&#39;</span><span class="p">,</span> <span class="n">transformed_colors</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle&#39;</span><span class="p">,</span> <span class="n">transformed_color_cycle</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_properties</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">color_mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refresh_colors</span><span class="p">(</span><span class="n">update_color_mapping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list of float: edge width for each shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">edge_widths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;list of int: z_index for each shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">z_indices</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set: set of currently selected shapes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data</span>

    <span class="nd">@selected_data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">selected_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">selected_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_data</span><span class="p">)</span>

        <span class="c1"># Update properties based on selected shapes</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selected_data_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selected_data</span><span class="p">)</span>
            <span class="n">selected_face_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_face_color</span><span class="p">[</span>
                <span class="n">selected_data_indices</span>
            <span class="p">]</span>
            <span class="n">face_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">selected_face_colors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_colors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">face_color</span> <span class="o">=</span> <span class="n">face_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_update_properties</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_face_color</span> <span class="o">=</span> <span class="n">face_color</span>

            <span class="n">selected_edge_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_edge_color</span><span class="p">[</span>
                <span class="n">selected_data_indices</span>
            <span class="p">]</span>
            <span class="n">edge_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">selected_edge_colors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_colors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">edge_color</span> <span class="o">=</span> <span class="n">edge_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_update_properties</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_edge_color</span> <span class="o">=</span> <span class="n">edge_color</span>

            <span class="n">edge_width</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">edge_width</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selected_data</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_width</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">edge_width</span> <span class="o">=</span> <span class="n">edge_width</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_update_properties</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_edge_width</span> <span class="o">=</span> <span class="n">edge_width</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">selected_data_indices</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">n_unique_properties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">n_unique_properties</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_update_properties</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span> <span class="o">=</span> <span class="n">properties</span>

    <span class="k">def</span> <span class="nf">_set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the face_color or edge_color property</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color : (N, 4) array or str</span>
<span class="sd">            The value for setting edge or face_color</span>
<span class="sd">        attribute : str in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_color or &#39;face&#39; for face_color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_color_mapped</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">guess_continuous</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">color</span><span class="p">]):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_colors</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">transformed_color</span> <span class="o">=</span> <span class="n">transform_color_with_defaults</span><span class="p">(</span>
                    <span class="n">num_entries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                    <span class="n">colors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">elem_name</span><span class="o">=</span><span class="s2">&quot;face_color&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">normalize_and_broadcast_colors</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">transformed_color</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">)</span>

            <span class="n">color_event</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color&#39;</span><span class="p">)</span>
            <span class="n">color_event</span><span class="p">()</span>

<div class="viewcode-block" id="Shapes.refresh_colors"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.refresh_colors">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_color_mapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate and update face and edge colors if using a cycle or color map</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        update_color_mapping : bool</span>
<span class="sd">            If set to True, the function will recalculate the color cycle map</span>
<span class="sd">            or colormap (whichever is being used). If set to False, the function</span>
<span class="sd">            will use the current color cycle map or color map. For example, if you</span>
<span class="sd">            are adding/modifying shapes and want them to be colored with the same</span>
<span class="sd">            mapping as the other shapes (i.e., the new shapes shouldn&#39;t affect</span>
<span class="sd">            the color cycle map or colormap), set update_color_mapping=False.</span>
<span class="sd">            Default value is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_color</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="n">update_color_mapping</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_color</span><span class="p">(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">update_color_mapping</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_refresh_color</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">update_color_mapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate and update face or edge colors if using a cycle or color map</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attribute : str  in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_color or &#39;face&#39; for face_color.</span>
<span class="sd">        update_color_mapping : bool</span>
<span class="sd">            If set to True, the function will recalculate the color cycle map</span>
<span class="sd">            or colormap (whichever is being used). If set to False, the function</span>
<span class="sd">            will use the current color cycle map or color map. For example, if you</span>
<span class="sd">            are adding/modifying shapes and want them to be colored with the same</span>
<span class="sd">            mapping as the other shapes (i.e., the new shapes shouldn&#39;t affect</span>
<span class="sd">            the color cycle map or colormap), set update_color_mapping=False.</span>
<span class="sd">            Default value is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_properties</span><span class="p">:</span>
            <span class="n">color_mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">]:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_color</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">update_color_mapping</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>

                <span class="n">color_event</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color&#39;</span><span class="p">)</span>
                <span class="n">color_event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_initialize_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_shapes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the face/edge colors the Shapes layer will be initialized with</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color : (N, 4) array or str</span>
<span class="sd">            The value for setting edge or face_color</span>
<span class="sd">        attribute : str in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_color or &#39;face&#39; for face_color.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        init_colors : (N, 4) array or str</span>
<span class="sd">            The calculated values for setting edge or face_color</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_color_mapped</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">guess_continuous</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">color</span><span class="p">]):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
            <span class="n">init_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_color</span><span class="p">(</span>
                <span class="n">attribute</span><span class="p">,</span> <span class="n">update_color_mapping</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_shapes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">transformed_color</span> <span class="o">=</span> <span class="n">transform_color_with_defaults</span><span class="p">(</span>
                    <span class="n">num_entries</span><span class="o">=</span><span class="n">n_shapes</span><span class="p">,</span>
                    <span class="n">colors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">elem_name</span><span class="o">=</span><span class="s2">&quot;face_color&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">init_colors</span> <span class="o">=</span> <span class="n">normalize_and_broadcast_colors</span><span class="p">(</span>
                    <span class="n">n_shapes</span><span class="p">,</span> <span class="n">transformed_color</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">init_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">,</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">init_colors</span>

    <span class="k">def</span> <span class="nf">_map_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">update_color_mapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the mapping for face or edge colors if using a cycle or color map</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attribute : str  in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_color or &#39;face&#39; for face_color.</span>
<span class="sd">        update_color_mapping : bool</span>
<span class="sd">            If set to True, the function will recalculate the color cycle map</span>
<span class="sd">            or colormap (whichever is being used). If set to False, the function</span>
<span class="sd">            will use the current color cycle map or color map. For example, if you</span>
<span class="sd">            are adding/modifying shapes and want them to be colored with the same</span>
<span class="sd">            mapping as the other shapes (i.e., the new shapes shouldn&#39;t affect</span>
<span class="sd">            the color cycle map or colormap), set update_color_mapping=False.</span>
<span class="sd">            Default value is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        colors : (N, 4) array or str</span>
<span class="sd">            The calculated values for setting edge or face_color</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">color_mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">:</span>
            <span class="n">color_property</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="n">color_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">color_property</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">update_color_mapping</span><span class="p">:</span>
                <span class="n">color_cycle</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle&#39;</span><span class="p">)</span>
                <span class="n">color_cycle_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">transform_color</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">color_properties</span><span class="p">),</span> <span class="n">color_cycle</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_map&#39;</span><span class="p">,</span> <span class="n">color_cycle_map</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># add properties if they are not in the colormap</span>
                <span class="c1"># and update_color_mapping==False</span>
                <span class="n">color_cycle_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_map&#39;</span><span class="p">)</span>
                <span class="n">color_cycle_keys</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">color_cycle_map</span><span class="p">]</span>
                <span class="n">props_in_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">color_properties</span><span class="p">,</span> <span class="n">color_cycle_keys</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">props_in_map</span><span class="p">):</span>
                    <span class="n">props_to_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                        <span class="n">color_properties</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">props_in_map</span><span class="p">)]</span>
                    <span class="p">)</span>
                    <span class="n">color_cycle</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">props_to_add</span><span class="p">:</span>
                        <span class="n">color_cycle_map</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
                            <span class="n">transform_color</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">))</span>
                        <span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_map&#39;</span><span class="p">,</span> <span class="n">color_cycle_map</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">color_cycle_map</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">color_properties</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">:</span>
            <span class="n">color_property</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="n">color_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">color_property</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_properties</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">contrast_limits</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_contrast_limits&#39;</span><span class="p">)</span>
                <span class="n">colormap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_colormap&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">update_color_mapping</span> <span class="ow">or</span> <span class="n">contrast_limits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="n">colors</span><span class="p">,</span> <span class="n">contrast_limits</span> <span class="o">=</span> <span class="n">map_property</span><span class="p">(</span>
                        <span class="n">prop</span><span class="o">=</span><span class="n">color_properties</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span>
                    <span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_contrast_limits&#39;</span><span class="p">,</span> <span class="n">contrast_limits</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="n">colors</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_property</span><span class="p">(</span>
                        <span class="n">prop</span><span class="o">=</span><span class="n">color_properties</span><span class="p">,</span>
                        <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
                        <span class="n">contrast_limits</span><span class="o">=</span><span class="n">contrast_limits</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">colors</span>

    <span class="k">def</span> <span class="nf">_get_new_shape_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adding</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the color for the shape(s) to be added.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        adding : int</span>
<span class="sd">            the number of shapes that were added</span>
<span class="sd">            (and thus the number of color entries to add)</span>
<span class="sd">        attribute : str in {&#39;edge&#39;, &#39;face&#39;}</span>
<span class="sd">            The name of the attribute to set the color of.</span>
<span class="sd">            Should be &#39;edge&#39; for edge_color_mode or &#39;face&#39; for face_color_mode.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_colors : (N, 4) array</span>
<span class="sd">            (Nx4) RGBA array of colors for the N new shapes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">color_mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_mode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">:</span>
            <span class="n">current_face_color</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_current_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color&#39;</span><span class="p">)</span>
            <span class="n">new_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">current_face_color</span><span class="p">,</span> <span class="p">(</span><span class="n">adding</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">CYCLE</span><span class="p">:</span>
            <span class="n">property_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="n">color_property_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span><span class="p">[</span><span class="n">property_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># check if the new color property is in the cycle map</span>
            <span class="c1"># and add it if it is not</span>
            <span class="n">color_cycle_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_map&#39;</span><span class="p">)</span>
            <span class="n">color_cycle_keys</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">color_cycle_map</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">color_property_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">color_cycle_keys</span><span class="p">:</span>
                <span class="n">color_cycle</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle&#39;</span><span class="p">)</span>
                <span class="n">color_cycle_map</span><span class="p">[</span><span class="n">color_property_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
                    <span class="n">transform_color</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_cycle_map&#39;</span><span class="p">,</span> <span class="n">color_cycle_map</span><span class="p">)</span>

            <span class="n">new_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">color_cycle_map</span><span class="p">[</span><span class="n">color_property_value</span><span class="p">],</span> <span class="p">(</span><span class="n">adding</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">color_mode</span> <span class="o">==</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">COLORMAP</span><span class="p">:</span>
            <span class="n">property_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_color_property&#39;</span><span class="p">)</span>
            <span class="n">color_property_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span><span class="p">[</span><span class="n">property_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_colormap&#39;</span><span class="p">)</span>
            <span class="n">contrast_limits</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">attribute</span><span class="si">}</span><span class="s1">_contrast_limits&#39;</span><span class="p">)</span>

            <span class="n">fc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">map_property</span><span class="p">(</span>
                <span class="n">prop</span><span class="o">=</span><span class="n">color_property_value</span><span class="p">,</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
                <span class="n">contrast_limits</span><span class="o">=</span><span class="n">contrast_limits</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">new_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="p">(</span><span class="n">adding</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_colors</span>

    <span class="k">def</span> <span class="nf">_is_color_mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; determines if the new color argument is for directly setting or cycle/colormap&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;face_color should be the name of a color, an array of colors, or the name of an property&#39;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get dictionary of layer state.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        state : dict</span>
<span class="sd">            Dictionary of layer state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_state</span><span class="p">()</span>
        <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span>
                <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">_get_state</span><span class="p">(),</span>
                <span class="s1">&#39;shape_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_type</span><span class="p">,</span>
                <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opacity</span><span class="p">,</span>
                <span class="s1">&#39;z_index&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_index</span><span class="p">,</span>
                <span class="s1">&#39;edge_width&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_width</span><span class="p">,</span>
                <span class="s1">&#39;face_color&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_color</span><span class="p">,</span>
                <span class="s1">&#39;face_color_cycle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_color_cycle</span><span class="p">,</span>
                <span class="s1">&#39;face_colormap&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_colormap</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;face_contrast_limits&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_contrast_limits</span><span class="p">,</span>
                <span class="s1">&#39;edge_color&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_color</span><span class="p">,</span>
                <span class="s1">&#39;edge_color_cycle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_color_cycle</span><span class="p">,</span>
                <span class="s1">&#39;edge_colormap&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_colormap</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;edge_contrast_limits&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_contrast_limits</span><span class="p">,</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_indices_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_displayed</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_view_text</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the values of the text elements in view</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        text : (N x 1) np.ndarray</span>
<span class="sd">            Array of text strings for the N text elements in view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">view_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices_view</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_view_text_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the coordinates of the text elements in view</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        text_coords : (N x D) np.ndarray</span>
<span class="sd">            Array of coordindates for the N text elements in view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">compute_text_coords</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;MODE: Interactive mode. The normal, default mode is PAN_ZOOM, which</span>
<span class="sd">        allows for normal interactivity with the canvas.</span>

<span class="sd">        The SELECT mode allows for entire shapes to be selected, moved and</span>
<span class="sd">        resized.</span>

<span class="sd">        The DIRECT mode allows for shapes to be selected and their individual</span>
<span class="sd">        vertices to be moved.</span>

<span class="sd">        The VERTEX_INSERT and VERTEX_REMOVE modes allow for individual</span>
<span class="sd">        vertices either to be added to or removed from shapes that are already</span>
<span class="sd">        selected. Note that shapes cannot be selected in this mode.</span>

<span class="sd">        The ADD_RECTANGLE, ADD_ELLIPSE, ADD_LINE, ADD_PATH, and ADD_POLYGON</span>
<span class="sd">        modes all allow for their corresponding shape type to be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>

    <span class="nd">@mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">editable</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="o">.</span><span class="n">PAN_ZOOM</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">old_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>

        <span class="k">if</span> <span class="n">old_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_move_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">highlight</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_INSERT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vertex_insert</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_move_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">highlight</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_REMOVE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vertex_remove</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_move_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">highlight</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_RECTANGLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">add_rectangle</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_ELLIPSE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">add_ellipse</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_LINE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">add_line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">ADD_PATH</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_POLYGON</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">add_path_polygon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_move_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">add_path_polygon_creating</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">PAN_ZOOM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;enter a selection mode to edit shape properties&#39;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="s1">&#39;pointing&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;hold &lt;space&gt; to pan/zoom, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;press &lt;</span><span class="si">{</span><span class="n">BACKSPACE</span><span class="si">}</span><span class="s1">&gt; to remove selected&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_move_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">highlight</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_INSERT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_REMOVE</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="s1">&#39;cross&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;hold &lt;space&gt; to pan/zoom&#39;</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_INSERT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertex_insert</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertex_remove</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_move_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">highlight</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">ADD_RECTANGLE</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_ELLIPSE</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_LINE</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="s1">&#39;cross&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;hold &lt;space&gt; to pan/zoom&#39;</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_RECTANGLE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_rectangle</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_ELLIPSE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_ellipse</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_LINE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">ADD_PATH</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_POLYGON</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="s1">&#39;cross&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;hold &lt;space&gt; to pan/zoom, &#39;</span> <span class="s1">&#39;press &lt;esc&gt; to finish drawing&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_drag_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_path_polygon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mouse_move_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_path_polygon_creating</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode not recognized&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="n">draw_modes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Mode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span>
            <span class="n">Mode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">,</span>
            <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_INSERT</span><span class="p">,</span>
            <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_REMOVE</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="c1"># don&#39;t update thumbnail on mode changes</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_thumbnail_update</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mode</span> <span class="ow">in</span> <span class="n">draw_modes</span> <span class="ow">and</span> <span class="n">old_mode</span> <span class="ow">in</span> <span class="n">draw_modes</span><span class="p">):</span>
                <span class="c1"># Shapes._finish_drawing() calls Shapes.refresh()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_finish_drawing</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_editable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set editable mode based on layer properties.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">editable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">editable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="o">.</span><span class="n">PAN_ZOOM</span>

<div class="viewcode-block" id="Shapes.add"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">shape_type</span><span class="o">=</span><span class="s1">&#39;rectangle&#39;</span><span class="p">,</span>
        <span class="n">edge_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">face_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">z_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add shapes to the current layer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : list or array</span>
<span class="sd">            List of shape data, where each element is an (N, D) array of the</span>
<span class="sd">            N vertices of a shape in D dimensions. Can be an 3-dimensional</span>
<span class="sd">            array if each shape has the same number of vertices.</span>
<span class="sd">        shape_type : string | list</span>
<span class="sd">            String of shape shape_type, must be one of &quot;{&#39;line&#39;, &#39;rectangle&#39;,</span>
<span class="sd">            &#39;ellipse&#39;, &#39;path&#39;, &#39;polygon&#39;}&quot;. If a list is supplied it must be</span>
<span class="sd">            the same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        edge_width : float | list</span>
<span class="sd">            thickness of lines and edges. If a list is supplied it must be the</span>
<span class="sd">            same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        edge_color : str | tuple | list</span>
<span class="sd">            If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">            starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">            or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">            the length of `data` and each element will be applied to each shape</span>
<span class="sd">            otherwise the same value will be used for all shapes.</span>
<span class="sd">        face_color : str | tuple | list</span>
<span class="sd">            If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">            starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">            or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">            the length of `data` and each element will be applied to each shape</span>
<span class="sd">            otherwise the same value will be used for all shapes.</span>
<span class="sd">        z_index : int | list</span>
<span class="sd">            Specifier of z order priority. Shapes with higher z order are</span>
<span class="sd">            displayed ontop of others. If a list is supplied it must be the</span>
<span class="sd">            same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">edge_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_edge_width</span>

        <span class="n">n_new_shapes</span> <span class="o">=</span> <span class="n">number_of_shapes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">edge_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_shape_color</span><span class="p">(</span>
                <span class="n">n_new_shapes</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">face_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">face_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_shape_color</span><span class="p">(</span>
                <span class="n">n_new_shapes</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;face&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">z_index</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_z_index</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">z_index</span> <span class="ow">or</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">n_new_shapes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="n">new_property</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">n_new_shapes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">new_property</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_properties</span><span class="p">,</span> <span class="n">n_new_shapes</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_shapes</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">shape_type</span><span class="o">=</span><span class="n">shape_type</span><span class="p">,</span>
                <span class="n">edge_width</span><span class="o">=</span><span class="n">edge_width</span><span class="p">,</span>
                <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                <span class="n">face_color</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                <span class="n">z_index</span><span class="o">=</span><span class="n">z_index</span><span class="p">,</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_shapes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">shape_type</span><span class="o">=</span><span class="s1">&#39;rectangle&#39;</span><span class="p">,</span>
        <span class="n">edge_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_color_cycle</span><span class="p">,</span>
        <span class="n">edge_colormap</span><span class="p">,</span>
        <span class="n">edge_contrast_limits</span><span class="p">,</span>
        <span class="n">face_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">face_color_cycle</span><span class="p">,</span>
        <span class="n">face_colormap</span><span class="p">,</span>
        <span class="n">face_contrast_limits</span><span class="p">,</span>
        <span class="n">z_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add shapes to the data view.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : list or array</span>
<span class="sd">            List of shape data, where each element is an (N, D) array of the</span>
<span class="sd">            N vertices of a shape in D dimensions. Can be an 3-dimensional</span>
<span class="sd">            array if each shape has the same number of vertices.</span>
<span class="sd">        shape_type : string | list</span>
<span class="sd">            String of shape shape_type, must be one of &quot;{&#39;line&#39;, &#39;rectangle&#39;,</span>
<span class="sd">            &#39;ellipse&#39;, &#39;path&#39;, &#39;polygon&#39;}&quot;. If a list is supplied it must be</span>
<span class="sd">            the same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        edge_width : float | list</span>
<span class="sd">            thickness of lines and edges. If a list is supplied it must be the</span>
<span class="sd">            same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        edge_color : str | tuple | list</span>
<span class="sd">            If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">            starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">            or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">            the length of `data` and each element will be applied to each shape</span>
<span class="sd">            otherwise the same value will be used for all shapes.</span>
<span class="sd">        face_color : str | tuple | list</span>
<span class="sd">            If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">            starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">            or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">            the length of `data` and each element will be applied to each shape</span>
<span class="sd">            otherwise the same value will be used for all shapes.</span>
<span class="sd">        z_index : int | list</span>
<span class="sd">            Specifier of z order priority. Shapes with higher z order are</span>
<span class="sd">            displayed ontop of others. If a list is supplied it must be the</span>
<span class="sd">            same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_shapes</span> <span class="o">=</span> <span class="n">number_of_shapes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_update_properties</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edge_color_property</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edge_color_cycle_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edge_colormap</span> <span class="o">=</span> <span class="n">edge_colormap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_edge_contrast_limits</span> <span class="o">=</span> <span class="n">edge_contrast_limits</span>
            <span class="k">if</span> <span class="n">edge_color_cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">edge_color_cycle</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">DEFAULT_COLOR_CYCLE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edge_color_cycle</span> <span class="o">=</span> <span class="n">edge_color_cycle</span>
            <span class="n">edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_color</span><span class="p">(</span>
                <span class="n">edge_color</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">n_shapes</span><span class="o">=</span><span class="n">n_shapes</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_face_color_property</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">face_color_cycle_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">face_colormap</span> <span class="o">=</span> <span class="n">face_colormap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_face_contrast_limits</span> <span class="o">=</span> <span class="n">face_contrast_limits</span>
            <span class="k">if</span> <span class="n">face_color_cycle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">face_color_cycle</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">DEFAULT_COLOR_CYCLE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">face_color_cycle</span> <span class="o">=</span> <span class="n">face_color_cycle</span>
            <span class="n">face_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_color</span><span class="p">(</span>
                <span class="n">face_color</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="n">n_shapes</span><span class="o">=</span><span class="n">n_shapes</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_thumbnail_update</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_shapes</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">shape_type</span><span class="o">=</span><span class="n">shape_type</span><span class="p">,</span>
                <span class="n">edge_width</span><span class="o">=</span><span class="n">edge_width</span><span class="p">,</span>
                <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                <span class="n">face_color</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                <span class="n">z_index</span><span class="o">=</span><span class="n">z_index</span><span class="p">,</span>
                <span class="n">z_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_update_z_order</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_colors</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_shapes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">shape_type</span><span class="o">=</span><span class="s1">&#39;rectangle&#39;</span><span class="p">,</span>
        <span class="n">edge_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">face_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">z_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">z_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add shapes to the data view.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : list or array</span>
<span class="sd">            List of shape data, where each element is an (N, D) array of the</span>
<span class="sd">            N vertices of a shape in D dimensions. Can be an 3-dimensional</span>
<span class="sd">            array if each shape has the same number of vertices.</span>
<span class="sd">        shape_type : string | list</span>
<span class="sd">            String of shape shape_type, must be one of &quot;{&#39;line&#39;, &#39;rectangle&#39;,</span>
<span class="sd">            &#39;ellipse&#39;, &#39;path&#39;, &#39;polygon&#39;}&quot;. If a list is supplied it must be</span>
<span class="sd">            the same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        edge_width : float | list</span>
<span class="sd">            thickness of lines and edges. If a list is supplied it must be the</span>
<span class="sd">            same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        edge_color : str | tuple | list</span>
<span class="sd">            If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">            starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">            or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">            the length of `data` and each element will be applied to each shape</span>
<span class="sd">            otherwise the same value will be used for all shapes.</span>
<span class="sd">        face_color : str | tuple | list</span>
<span class="sd">            If string can be any color name recognized by vispy or hex value if</span>
<span class="sd">            starting with `#`. If array-like must be 1-dimensional array with 3</span>
<span class="sd">            or 4 elements. If a list is supplied it must be the same length as</span>
<span class="sd">            the length of `data` and each element will be applied to each shape</span>
<span class="sd">            otherwise the same value will be used for all shapes.</span>
<span class="sd">        z_index : int | list</span>
<span class="sd">            Specifier of z order priority. Shapes with higher z order are</span>
<span class="sd">            displayed ontop of others. If a list is supplied it must be the</span>
<span class="sd">            same length as the length of `data` and each element will be</span>
<span class="sd">            applied to each shape otherwise the same value will be used for all</span>
<span class="sd">            shapes.</span>
<span class="sd">        z_refresh : bool</span>
<span class="sd">            If set to true, the mesh elements are reindexed with the new z order.</span>
<span class="sd">            When shape_index is provided, z_refresh will be overwritten to false,</span>
<span class="sd">            as the z indices will not change.</span>
<span class="sd">            When adding a batch of shapes, set to false  and then call</span>
<span class="sd">            ShapesList._update_z_order() once at the end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">edge_width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_edge_width</span>
        <span class="k">if</span> <span class="n">edge_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_edge_color</span>
        <span class="k">if</span> <span class="n">face_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">face_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_face_color</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">z_index</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_z_index</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">z_index</span> <span class="ow">or</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If a single array for a shape has been passed turn into list</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

            <span class="c1"># transform the colors</span>
            <span class="n">transformed_ec</span> <span class="o">=</span> <span class="n">transform_color_with_defaults</span><span class="p">(</span>
                <span class="n">num_entries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                <span class="n">elem_name</span><span class="o">=</span><span class="s2">&quot;edge_color&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">transformed_edge_color</span> <span class="o">=</span> <span class="n">normalize_and_broadcast_colors</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">transformed_ec</span>
            <span class="p">)</span>
            <span class="n">transformed_fc</span> <span class="o">=</span> <span class="n">transform_color_with_defaults</span><span class="p">(</span>
                <span class="n">num_entries</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span>
                <span class="n">elem_name</span><span class="o">=</span><span class="s2">&quot;face_color&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">transformed_face_color</span> <span class="o">=</span> <span class="n">normalize_and_broadcast_colors</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">transformed_fc</span>
            <span class="p">)</span>

            <span class="c1"># Turn input arguments into iterables</span>
            <span class="n">shape_inputs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">shape_type</span><span class="p">),</span>
                <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">edge_width</span><span class="p">),</span>
                <span class="n">transformed_edge_color</span><span class="p">,</span>
                <span class="n">transformed_face_color</span><span class="p">,</span>
                <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">z_index</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ew</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">shape_inputs</span><span class="p">:</span>

                <span class="c1"># A False slice_key means the shape is invalid as it is not</span>
                <span class="c1"># confined to a single plane</span>
                <span class="n">shape_cls</span> <span class="o">=</span> <span class="n">shape_classes</span><span class="p">[</span><span class="n">ShapeType</span><span class="p">(</span><span class="n">st</span><span class="p">)]</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">shape_cls</span><span class="p">(</span>
                    <span class="n">d</span><span class="p">,</span>
                    <span class="n">edge_width</span><span class="o">=</span><span class="n">ew</span><span class="p">,</span>
                    <span class="n">z_index</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
                    <span class="n">dims_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims_order</span><span class="p">,</span>
                    <span class="n">ndisplay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Add shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">shape</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">ec</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="n">fc</span><span class="p">,</span> <span class="n">z_refresh</span><span class="o">=</span><span class="n">z_refresh</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_display_order_stored</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims_order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay_stored</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dims</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_validate_properties</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">n_shapes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Validates the type and size of the properties&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_shapes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_shapes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_shapes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;the number of properties must equal the number of shapes&#39;</span>
                <span class="p">)</span>
            <span class="c1"># ensure the property values are a numpy array</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TextManager</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;TextManager: The TextManager object containing the text properties&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span>

    <span class="nd">@text</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="o">.</span><span class="n">_set_text</span><span class="p">(</span>
            <span class="n">text</span><span class="p">,</span> <span class="n">n_text</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">properties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Shapes.refresh_text"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.refresh_text">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Refresh the text values.</span>

<span class="sd">        This is generally used if the properties were updated without changing the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">refresh_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_view_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the view given the slicing indices.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay_stored</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">ndisplay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay_stored</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_order</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_order_stored</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">update_dims_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims_order</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_order_stored</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims_order</span><span class="p">)</span>
            <span class="c1"># Clear clipboard if dimensions swap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">slice_key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slice_indices</span><span class="p">)[</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dims_not_displayed</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">slice_key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">slice_key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">slice_key</span> <span class="o">=</span> <span class="n">slice_key</span>

<div class="viewcode-block" id="Shapes.interaction_box"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.interaction_box">[docs]</a>    <span class="k">def</span> <span class="nf">interaction_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the interaction box around a shape or list of shapes.</span>
<span class="sd">        If a single index is passed then the boudning box will be inherited</span>
<span class="sd">        from that shapes interaction box. If list of indices is passed it will</span>
<span class="sd">        be computed directly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int | list</span>
<span class="sd">            Index of a single shape, or a list of shapes around which to</span>
<span class="sd">            construct the interaction box</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        box : np.ndarray</span>
<span class="sd">            10x2 array of vertices of the interaction box. The first 8 points</span>
<span class="sd">            are the corners and midpoints of the box in clockwise order</span>
<span class="sd">            starting in the upper-left corner. The 9th point is the center of</span>
<span class="sd">            the box, and the last point is the location of the rotation handle</span>
<span class="sd">            that can be used to rotate the box</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_box</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">create_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_vertices</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">_box</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rot</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_CENTER</span><span class="p">]</span>
            <span class="n">length_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">BOTTOM_LEFT</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_LEFT</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">length_box</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotation_handle_length</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span>
                <span class="n">rot</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">rot</span>
                    <span class="o">-</span> <span class="n">r</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">BOTTOM_LEFT</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_LEFT</span><span class="p">])</span>
                    <span class="o">/</span> <span class="n">length_box</span>
                <span class="p">)</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="p">[</span><span class="n">rot</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">box</span></div>

    <span class="k">def</span> <span class="nf">_outline_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find outlines of any selected or hovered shapes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vertices : None | np.ndarray</span>
<span class="sd">            Nx2 array of any vertices of outline or None</span>
<span class="sd">        triangles : None | np.ndarray</span>
<span class="sd">            Mx3 array of any indices of vertices for triangles of outline or</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">index</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">centers</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">triangles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">centers</span> <span class="o">+</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_width</span> <span class="o">*</span> <span class="n">offsets</span>
            <span class="p">)</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">triangles</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">triangles</span>

    <span class="k">def</span> <span class="nf">_compute_vertices_and_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute location of highlight vertices and box for rendering.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vertices : np.ndarray</span>
<span class="sd">            Nx2 array of any vertices to be rendered as Markers</span>
<span class="sd">        face_color : str</span>
<span class="sd">            String of the face color of the Markers</span>
<span class="sd">        edge_color : str</span>
<span class="sd">            String of the edge color of the Markers and Line for the box</span>
<span class="sd">        pos : np.ndarray</span>
<span class="sd">            Nx2 array of vertices of the box that will be rendered using a</span>
<span class="sd">            Vispy Line</span>
<span class="sd">        width : float</span>
<span class="sd">            Width of the box edge</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
                <span class="c1"># If in select mode just show the interaction boudning box</span>
                <span class="c1"># including its vertices and the rotation handle</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">WITH_HANDLE</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_color</span>
                <span class="n">edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_color</span>
                <span class="n">vertices</span> <span class="o">=</span> <span class="n">box</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Use a subset of the vertices of the interaction_box to plot</span>
                <span class="c1"># the line around the edge</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">LINE_HANDLE</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_PATH</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_POLYGON</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_RECTANGLE</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_ELLIPSE</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_LINE</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_INSERT</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_REMOVE</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># If in one of these mode show the vertices of the shape itself</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_vertices</span><span class="p">[</span><span class="n">inds</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># If currently adding path don&#39;t show box over last vertex</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_PATH</span><span class="p">:</span>
                    <span class="n">vertices</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">face_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_color</span>
                <span class="n">edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_color</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise show nothing</span>
                <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                <span class="n">edge_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_selecting</span><span class="p">:</span>
            <span class="c1"># If currently dragging a selection box just show an outline of</span>
            <span class="c1"># that box</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_color</span>
            <span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">create_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="c1"># Use a subset of the vertices of the interaction_box to plot</span>
            <span class="c1"># the line around the edge</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">LINE</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise show nothing</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">face_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
            <span class="n">edge_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">face_color</span><span class="p">,</span> <span class="n">edge_color</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">width</span>

    <span class="k">def</span> <span class="nf">_set_highlight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Render highlights of shapes.</span>

<span class="sd">        Includes boundaries, vertices, interaction boxes, and the drag</span>
<span class="sd">        selection box when appropriate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force : bool</span>
<span class="sd">            Bool that forces a redraw to occur when `True`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if any shape or vertex ids have changed since last call</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data_stored</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_stored</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box_stored</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data_stored</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value_stored</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box_stored</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">highlight</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_finish_drawing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset properties used in shape drawing.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_moving_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_moving</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_selecting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moving_value</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_creating</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_PATH</span><span class="p">:</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_vertices</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span> <span class="o">==</span> <span class="n">index</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_shape</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">data_full</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_creating</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_POLYGON</span><span class="p">:</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_vertices</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span> <span class="o">==</span> <span class="n">index</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_shape</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">data_full</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_creating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dims</span><span class="p">()</span>

<div class="viewcode-block" id="Shapes.block_thumbnail_update"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.block_thumbnail_update">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">block_thumbnail_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use this context manager to block thumbnail updates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_thumbnail_update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_thumbnail_update</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_update_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update thumbnail with current shapes and colors.&quot;&quot;&quot;</span>

        <span class="c1"># don&#39;t update the thumbnail if dragging a shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_moving</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_thumbnail_update</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># calculate min vals for the vertices and pad with 0.5</span>
            <span class="c1"># the offset is needed to ensure that the top left corner of the shapes</span>
            <span class="c1"># corresponds to the top left corner of the thumbnail</span>
            <span class="n">de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extent_data</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">de</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_displayed</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span>
            <span class="c1"># calculate range of values for the vertices and pad with 1</span>
            <span class="c1"># padding ensures the entire shape can be represented in the thumbnail</span>
            <span class="c1"># without getting clipped</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="p">[</span><span class="n">de</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">de</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_displayed</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">zoom_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thumbnail_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="n">colormapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">to_colors</span><span class="p">(</span>
                <span class="n">colors_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thumbnail_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">zoom_factor</span><span class="o">=</span><span class="n">zoom_factor</span><span class="p">,</span>
                <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span>
                <span class="n">max_shapes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_shapes_thumbnail</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail</span> <span class="o">=</span> <span class="n">colormapped</span>

<div class="viewcode-block" id="Shapes.remove_selected"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.remove_selected">[docs]</a>    <span class="k">def</span> <span class="nf">remove_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove any selected shapes.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_edge_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_edge_color</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_face_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_face_color</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finish_drawing</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_rotate_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Perform a rotation on the selected box.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angle : float</span>
<span class="sd">            angle specifying rotation of shapes in degrees.</span>
<span class="sd">        center : list</span>
<span class="sd">            coordinates of center of rotation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]]</span>
        <span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">-</span> <span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">=</span> <span class="n">box</span> <span class="o">@</span> <span class="n">transform</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">center</span>

    <span class="k">def</span> <span class="nf">_scale_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Perform a scaling on the selected box.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scale : float, list</span>
<span class="sd">            scalar or list specifying rescaling of shape.</span>
<span class="sd">        center : list</span>
<span class="sd">            coordinates of center of rotation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">-</span> <span class="n">center</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_CENTER</span><span class="p">]</span> <span class="o">==</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotation_handle_length</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span>
            <span class="n">handle_vec</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_CENTER</span><span class="p">]</span>
            <span class="n">cur_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">handle_vec</span><span class="p">)</span>
            <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_CENTER</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">handle_vec</span> <span class="o">/</span> <span class="n">cur_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">=</span> <span class="n">box</span> <span class="o">+</span> <span class="n">center</span>

    <span class="k">def</span> <span class="nf">_transform_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Perform a linear transformation on the selected box.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transform : np.ndarray</span>
<span class="sd">            2x2 array specifying linear transform.</span>
<span class="sd">        center : list</span>
<span class="sd">            coordinates of center of rotation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">-</span> <span class="n">center</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">box</span> <span class="o">@</span> <span class="n">transform</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_CENTER</span><span class="p">]</span> <span class="o">==</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotation_handle_length</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span>
            <span class="n">handle_vec</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_CENTER</span><span class="p">]</span>
            <span class="n">cur_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">handle_vec</span><span class="p">)</span>
            <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">TOP_CENTER</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">handle_vec</span> <span class="o">/</span> <span class="n">cur_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">=</span> <span class="n">box</span> <span class="o">+</span> <span class="n">center</span>

<div class="viewcode-block" id="Shapes.expand_shape"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.expand_shape">[docs]</a>    <span class="k">def</span> <span class="nf">expand_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Expand shape from 2D to the full data dims.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : array</span>
<span class="sd">            2D data array of shape to be expanded.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_full : array</span>
<span class="sd">            Full D dimensional data array of the shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data_full</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_displayed_order</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slice_indices</span><span class="p">)</span>
            <span class="n">data_full</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_not_displayed</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dims_not_displayed</span>
            <span class="p">]</span>
            <span class="n">data_full</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_displayed</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">return</span> <span class="n">data_full</span></div>

    <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine if any shape at given coord using triangle meshes.</span>

<span class="sd">        Getting value is not supported yet for 3D meshes</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        shape : int | None</span>
<span class="sd">            Index of shape if any that is at the coordinates. Returns `None`</span>
<span class="sd">            if no shape is found.</span>
<span class="sd">        vertex : int | None</span>
<span class="sd">            Index of vertex if any that is at the coordinates. Returns `None`</span>
<span class="sd">            if no vertex is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndisplay</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_moving</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moving_value</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayed_coordinates</span>

        <span class="c1"># Check selected shapes</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">selected_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">Mode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
                <span class="c1"># Check if inside vertex of interaction box or rotation handle</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">WITH_HANDLE</span><span class="p">]</span>
                <span class="n">distances</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">box</span> <span class="o">-</span> <span class="n">coord</span><span class="p">)</span>

                <span class="c1"># Get the vertex sizes</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vertex_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">/</span> <span class="mi">2</span>

                <span class="c1"># Check if any matching vertices</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">distances</span> <span class="o">&lt;=</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_INSERT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_REMOVE</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># Check if inside vertex of shape</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span><span class="p">,</span> <span class="n">selected_index</span><span class="p">)</span>
                <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_vertices</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
                <span class="n">distances</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vertices</span> <span class="o">-</span> <span class="n">coord</span><span class="p">)</span>

                <span class="c1"># Get the vertex sizes</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vertex_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">/</span> <span class="mi">2</span>

                <span class="c1"># Check if any matching vertices</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">distances</span> <span class="o">&lt;=</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">inds</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="n">matches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">vals</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">shape_in_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">index</span> <span class="o">-</span> <span class="n">idx</span><span class="p">[</span><span class="n">shape_in_list</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check if mouse inside shape</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">inside</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="Shapes.move_to_front"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.move_to_front">[docs]</a>    <span class="k">def</span> <span class="nf">move_to_front</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Moves selected objects to be displayed in front of all others.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">new_z_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_z_index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">update_z_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">new_z_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>

<div class="viewcode-block" id="Shapes.move_to_back"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.move_to_back">[docs]</a>    <span class="k">def</span> <span class="nf">move_to_back</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Moves selected objects to be displayed behind all others.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">new_z_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_z_index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">update_z_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">new_z_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_copy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy selected shapes to clipboard.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_data</span>
                <span class="p">],</span>
                <span class="s1">&#39;edge_color&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_edge_color</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span>
                <span class="s1">&#39;face_color&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">_face_color</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span>
                <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slice_indices</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_paste_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Paste any shapes from clipboard and then selects them.&quot;&quot;&quot;</span>
        <span class="n">cur_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nshapes</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Calculate offset based on dimension shifts</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_slice_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_not_displayed</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Add new shape data</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_not_displayed</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
                    <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims_not_displayed</span>
                <span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="n">shape</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">face_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;face_color&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">edge_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;edge_color&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">shape</span><span class="p">,</span> <span class="n">face_color</span><span class="o">=</span><span class="n">face_color</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">cur_shapes</span><span class="p">,</span> <span class="n">cur_shapes</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clipboard</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">move_to_front</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Moves object at given mouse position and set of indices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coord : sequence of two int</span>
<span class="sd">            Position of mouse cursor in image coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vertex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moving_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_RECTANGLE</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_ELLIPSE</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_LINE</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_moving</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">vertex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Check where dragging box from to move whole object</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">CENTER</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="o">=</span> <span class="n">coord</span> <span class="o">-</span> <span class="n">center</span>
                    <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">CENTER</span><span class="p">]</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="n">coord</span> <span class="o">-</span> <span class="n">center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">+</span> <span class="n">shift</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">vertex</span> <span class="o">&lt;</span> <span class="n">Box</span><span class="o">.</span><span class="n">LEN</span><span class="p">:</span>
                    <span class="c1"># Corner / edge vertex is being dragged so resize object</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">vertex</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="n">Box</span><span class="o">.</span><span class="n">LEN</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span><span class="p">]</span>

                    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">box</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="n">Box</span><span class="o">.</span><span class="n">LEN</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">CENTER</span><span class="p">]</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">offset_perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

                    <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_aspect</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">-</span> <span class="n">fixed</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">new</span> <span class="o">-</span> <span class="n">fixed</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">new</span> <span class="o">-</span> <span class="n">fixed</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aspect_ratio</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aspect_ratio</span> <span class="o">/</span> <span class="n">ratio</span>
                            <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fixed</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">r</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aspect_ratio</span>
                            <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fixed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">r</span>

                    <span class="k">if</span> <span class="n">size</span> <span class="o">@</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">new</span> <span class="o">-</span> <span class="n">fixed</span><span class="p">)</span> <span class="o">@</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">size</span> <span class="o">@</span> <span class="n">offset</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">size</span> <span class="o">@</span> <span class="n">offset_perp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dist_perp</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dist_perp</span> <span class="o">=</span> <span class="p">((</span><span class="n">new</span> <span class="o">-</span> <span class="n">fixed</span><span class="p">)</span> <span class="o">@</span> <span class="n">offset_perp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="n">size</span> <span class="o">@</span> <span class="n">offset_perp</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># corner selected</span>
                        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dist_perp</span><span class="p">,</span> <span class="n">dist</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_index</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># top selected</span>
                        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">dist</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># side selected</span>
                        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dist_perp</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># prevent box from shrinking below a threshold size</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vertex_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">/</span> <span class="mi">8</span>
                    <span class="n">scale</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">size</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1"># check orientation of box</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
                                <span class="n">index</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span>
                            <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_box</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>
                        <span class="n">scale_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                        <span class="n">inv_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>
                        <span class="n">transform</span> <span class="o">=</span> <span class="n">rotation</span> <span class="o">@</span> <span class="n">scale_mat</span> <span class="o">@</span> <span class="n">inv_rot</span>
                        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_transform_box</span><span class="p">(</span>
                            <span class="n">transform</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">vertex</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="c1"># Rotation handle is being dragged so rotate object</span>
                    <span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span><span class="p">[</span><span class="n">Box</span><span class="o">.</span><span class="n">CENTER</span><span class="p">]</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">handle</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="p">)</span>

                    <span class="n">new_offset</span> <span class="o">=</span> <span class="n">coord</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span>
                    <span class="n">new_angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">new_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">new_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="n">fixed_offset</span> <span class="o">=</span> <span class="n">handle</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span>
                    <span class="n">fixed_angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">fixed_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">fixed_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">new_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_aspect</span><span class="p">:</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">new_angle</span> <span class="o">/</span> <span class="mi">45</span><span class="p">)</span> <span class="o">*</span> <span class="mi">45</span> <span class="o">-</span> <span class="n">fixed_angle</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="n">new_angle</span> <span class="o">-</span> <span class="n">fixed_angle</span>

                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span>
                            <span class="n">index</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_box</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_vertex</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_selecting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="o">=</span> <span class="n">coord</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span><span class="p">,</span> <span class="n">coord</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_highlight</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_PATH</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">ADD_POLYGON</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vertex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_moving</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moving_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">shape_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">Ellipse</span><span class="p">:</span>
                        <span class="c1"># DIRECT vertex moving of ellipse not implemented</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">Rectangle</span><span class="p">:</span>
                            <span class="n">new_type</span> <span class="o">=</span> <span class="n">Polygon</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_type</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_index</span> <span class="o">==</span> <span class="n">index</span>
                        <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">displayed_vertices</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
                        <span class="n">vertices</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord</span>
                        <span class="n">data_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_shape</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span>
                            <span class="n">index</span><span class="p">,</span> <span class="n">data_full</span><span class="p">,</span> <span class="n">new_type</span><span class="o">=</span><span class="n">new_type</span>
                        <span class="p">)</span>
                        <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_box</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_selecting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="o">=</span> <span class="n">coord</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span><span class="p">,</span> <span class="n">coord</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_highlight</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_INSERT</span><span class="p">,</span> <span class="n">Mode</span><span class="o">.</span><span class="n">VERTEX_REMOVE</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_selecting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span> <span class="o">=</span> <span class="n">coord</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_start</span><span class="p">,</span> <span class="n">coord</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_highlight</span><span class="p">()</span>

<div class="viewcode-block" id="Shapes.to_masks"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.to_masks">[docs]</a>    <span class="k">def</span> <span class="nf">to_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an array of binary masks, one for each shape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mask_shape : np.ndarray | tuple | None</span>
<span class="sd">            tuple defining shape of mask to be generated. If non specified,</span>
<span class="sd">            takes the max of all the vertiecs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        masks : np.ndarray</span>
<span class="sd">            Array where there is one binary mask for each shape</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extent_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extent_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">mask_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mask_shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">to_masks</span><span class="p">(</span><span class="n">mask_shape</span><span class="o">=</span><span class="n">mask_shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">masks</span></div>

<div class="viewcode-block" id="Shapes.to_labels"><a class="viewcode-back" href="../../../../api/napari.layers.shapes.html#napari.layers.shapes.shapes.Shapes.to_labels">[docs]</a>    <span class="k">def</span> <span class="nf">to_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an integer labels image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        labels_shape : np.ndarray | tuple | None</span>
<span class="sd">            Tuple defining shape of labels image to be generated. If non</span>
<span class="sd">            specified, takes the max of all the vertiecs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        labels : np.ndarray</span>
<span class="sd">            Integer array where each value is either 0 for background or an</span>
<span class="sd">            integer up to N for points inside the shape at the index value - 1.</span>
<span class="sd">            For overlapping shapes z-ordering will be respected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">labels_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extent_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extent_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">labels_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">labels_shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_view</span><span class="o">.</span><span class="n">to_labels</span><span class="p">(</span><span class="n">labels_shape</span><span class="o">=</span><span class="n">labels_shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">labels</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, napari contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>