<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Plugins" href="../plugins/index.html" /><link rel="prev" title="Translations" href="translations.html" />

    <meta name="generator" content="sphinx-3.5.4, furo 2021.06.18.beta36"/>
        <title>Contexts and Expressions in napari - napari</title>
      <link rel="stylesheet" href="../_static/styles/furo.css?digest=9b17055c4366e8b2949c66d6a9d8b0efe4dbaa60">
    <link rel="stylesheet" href="../_static/pygments.css">
    


<style>
  :root {
    --color-code-background: #002b36;
  --color-code-foreground: #839496;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #002b36;
  --color-code-foreground: #839496;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../_static/pygments_dark.css">
    <link rel="stylesheet" href="../_static/styles/furo-extensions.css?digest=ee12cdd73c4bbac24afec78d92c4afd7c2d8ea7f">
    <script async defer data-domain="napari.org" src="https://plausible.io/js/plausible.js"></script>
    
</head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">napari</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">napari</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Guides</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="3D_interactivity.html">3D interactivity</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_loop.html">An introduction to the event loop in napari</a></li>
<li class="toctree-l2"><a class="reference internal" href="connecting_events.html">Hooking up your own events</a></li>
<li class="toctree-l2"><a class="reference internal" href="events_reference.html">Events reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="threading.html">Multithreading in napari</a></li>
<li class="toctree-l2"><a class="reference internal" href="magicgui.html">Using <code class="docutils literal notranslate"><span class="pre">magicgui</span></code> in napari</a></li>
<li class="toctree-l2"><a class="reference internal" href="perfmon.html">Performance monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="rendering.html">Asynchronous rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="preferences.html">Preferences</a></li>
<li class="toctree-l2"><a class="reference internal" href="translations.html">Translations</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Contexts and Expressions in napari</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../plugins/index.html">Plugins</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../plugins/find-and-install-plugin.html">Finding and installing a napari plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/for_napari_developers.html">napari plugin architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/for_plugin_developers.html">Creating a napari plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/hook_specifications.html">napari hook specification reference</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developers/index.html">Developer resources</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../developers/team.html">About the project and team</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/benchmarks.html">Benchmarks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/code_of_conduct_reporting.html">Handling Code of Conduct reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/contributing.html">Contributing guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/core_dev_guide.html">Core Developer guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/docs.html">Organization of Documentation for napari</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/governance.html">Governance model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/mission_and_values.html">Mission and Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/working_groups.html">Working groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/release.html">Release guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/roadmap_0_3.html">Roadmap 0.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/roadmap_0_3_retrospective.html">Roadmap 0.3 Retrospective</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/roadmap_0_4.html">Roadmap 0.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../explanations/index.html">Explanations</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanations/docker.html">Napari in Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/performance.html">Napari performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/rendering.html">Rendering in napari</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../release/index.html">Release notes</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label for="toctree-checkbox-5"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_11.html">napari 0.4.11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_10.html">napari 0.4.10</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_9.html">napari 0.4.9</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_8.html">napari 0.4.8</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_7.html">napari 0.4.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_6.html">napari 0.4.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_5.html">napari 0.4.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_4.html">napari 0.4.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_3.html">napari 0.4.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_2.html">napari 0.4.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_1.html">napari 0.4.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_4_0.html">napari 0.4.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_8.html">napari 0.3.8</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_7.html">napari 0.3.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_6.html">napari 0.3.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_5.html">napari 0.3.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_4.html">napari 0.3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_3.html">napari 0.3.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_2.html">napari 0.3.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_1.html">napari 0.3.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_3_0.html">napari 0.3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_12.html">napari 0.2.12</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_11.html">napari 0.2.11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_10.html">napari 0.2.10</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_9.html">napari 0.2.9</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_8.html">napari 0.2.8</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_7.html">napari 0.2.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_6.html">napari 0.2.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_5.html">napari 0.2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_4.html">napari 0.2.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_3.html">napari 0.2.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_1.html">napari 0.2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_2_0.html">napari 0.2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_1_5.html">napari 0.1.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_1_3.html">napari 0.1.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release/release_0_1_0.html">napari 0.1.0</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label for="toctree-checkbox-6"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.layers.html">napari.layers</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label for="toctree-checkbox-7"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Image.html">napari.layers.Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Labels.html">napari.layers.Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Layer.html">napari.layers.Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Points.html">napari.layers.Points</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Shapes.html">napari.layers.Shapes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Surface.html">napari.layers.Surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Tracks.html">napari.layers.Tracks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.layers.Vectors.html">napari.layers.Vectors</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.view_layers.html">napari.view_layers</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label for="toctree-checkbox-8"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.view_layers.Viewer.html">napari.view_layers.Viewer</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.types.html">napari.types</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label for="toctree-checkbox-9"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.types.ArrayBase.html">napari.types.ArrayBase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.types.Path.html">napari.types.Path</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.types.SampleDict.html">napari.types.SampleDict</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.types.TracebackType.html">napari.types.TracebackType</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.types.TypedDict.html">napari.types.TypedDict</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.types.partial.html">napari.types.partial</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.utils.html">napari.utils</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label for="toctree-checkbox-10"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.utils.Colormap.html">napari.utils.Colormap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.utils.nbscreenshot.html">napari.utils.nbscreenshot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.utils.progress.html">napari.utils.progress</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.plugins.html">napari.plugins</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label for="toctree-checkbox-11"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.plugins.NapariPluginManager.html">napari.plugins.NapariPluginManager</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.components.html">napari.components</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label for="toctree-checkbox-12"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.components.Camera.html">napari.components.Camera</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.components.Dims.html">napari.components.Dims</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.components.LayerList.html">napari.components.LayerList</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.components.ViewerModel.html">napari.components.ViewerModel</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.qt.threading.html">napari.qt.threading</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label for="toctree-checkbox-13"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.qt.threading.FunctionWorker.html">napari.qt.threading.FunctionWorker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.qt.threading.GeneratorWorker.html">napari.qt.threading.GeneratorWorker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.qt.threading.GeneratorWorkerSignals.html">napari.qt.threading.GeneratorWorkerSignals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.qt.threading.WorkerBase.html">napari.qt.threading.WorkerBase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.qt.threading.WorkerBaseSignals.html">napari.qt.threading.WorkerBaseSignals</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.utils.perf.html">napari.utils.perf</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label for="toctree-checkbox-14"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.utils.perf.PerfEvent.html">napari.utils.perf.PerfEvent</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/napari.html">napari</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label for="toctree-checkbox-15"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/napari.Viewer.html">napari.Viewer</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="contexts-and-expressions-in-napari">
<h1>Contexts and Expressions in napari<a class="headerlink" href="#contexts-and-expressions-in-napari" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page is mostly aimed at developers who are interested in contributing to
or understanding the inner workings of napari.  While the concept of expressions
<em>will</em> be relevant for plugin developers writing plugin manifests, it won’t be
necessary for plugin devs or end-users to understand the implementation details
described on this page.</p>
</div>
<p>In napari, we’d like to be able to capture the <em>concept</em> of some condition being
<code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>, <em>prior</em> to actually having the context required to evaluate
it.  For example, a plugin (or napari itself) might want to stipulate that a
given function should only be enabled when “the active layer has at least 3
dimensions”.</p>
<p>At runtime, in Python code, this might be captured by the expression:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>However, if you don’t have access to an actual <code class="docutils literal notranslate"><span class="pre">viewer</span></code> instance, that
doesn’t work.</p>
<p><em>Contexts</em> and <em>Expressions</em> are two concepts being introduced along with the
second-generation napari plugin engine (npe2) that capture the abstract idea of
“some condition” (an <code class="docutils literal notranslate"><span class="pre">Expression</span></code>) that can be evaluated at some later time,
with a concrete set of keys and values (the <code class="docutils literal notranslate"><span class="pre">Context</span></code>).</p>
<div class="section" id="python-expressions">
<h2>Python expressions<a class="headerlink" href="#python-expressions" title="Permalink to this headline">¶</a></h2>
<p>In Python, <strong>expressions</strong> are simple combinations of <strong>values</strong> and
<strong>operations</strong> that can be reduced to a single value. For example, <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">&gt;</span> <span class="pre">5</span></code> is an
expression that always reduces to the value <code class="docutils literal notranslate"><span class="pre">False</span></code> when evaluated.  <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">5</span> <span class="pre">and</span> <span class="pre">y</span> <span class="pre">==</span> <span class="pre">'hello'</span></code> is also an expression that reduces to a boolean value; however, in
order to evaluate that expression, we need to be able to fill in the values for
the variable <strong>names</strong> “<code class="docutils literal notranslate"><span class="pre">x</span></code>” and “<code class="docutils literal notranslate"><span class="pre">y</span></code>”. Those values are provided by some
<strong>context</strong> (or “namespace”), which maps the variable names to their values.</p>
<p>The value of an <code class="docutils literal notranslate"><span class="pre">expression</span></code> depends on the context in which it is evaluated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">expression</span> <span class="o">=</span> <span class="s2">"x &gt; 5 and y == 'hello'"</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">context_a</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'x'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">:</span> <span class="s1">'hello'</span><span class="p">}</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">context_b</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'x'</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">:</span> <span class="s1">'howdie!'</span><span class="p">}</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">context_a</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="kc">True</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">context_b</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="section" id="napari-expressions">
<h2>Napari expressions<a class="headerlink" href="#napari-expressions" title="Permalink to this headline">¶</a></h2>
<p>Napari introduces <code class="docutils literal notranslate"><span class="pre">Expr</span></code> objects that represent an
expression “without a context”, to be evaluated later.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>napari’s <code class="docutils literal notranslate"><span class="pre">Expr</span></code> class subclasses from
<a class="reference external" href="https://docs.python.org/3/library/ast.html#ast.AST"><code class="docutils literal notranslate"><span class="pre">ast.AST</span></code></a> and shares many
similarities with the <code class="docutils literal notranslate"><span class="pre">body</span></code> of
<a class="reference external" href="https://docs.python.org/3/library/ast.html#ast.Expr"><code class="docutils literal notranslate"><span class="pre">ast.Expr</span></code></a>. However, for
the sake of evaluation safety, napari’s <code class="docutils literal notranslate"><span class="pre">Expr</span></code> only supports a subset of
operations, omitting things like function calls, generators, comprehensions, and
collections. It’s not important to fully understand ASTs to use napari
expressions, but for a good introduction to Python’s abstract syntax tree (AST)
module, see <a class="reference external" href="https://greentreesnakes.readthedocs.io">https://greentreesnakes.readthedocs.io</a>.</p>
</div>
<p>A string expression can be converted to a napari <code class="docutils literal notranslate"><span class="pre">Expr</span></code> object with the
<code class="docutils literal notranslate"><span class="pre">parse_expression</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">napari.utils.context</span> <span class="kn">import</span> <span class="n">parse_expression</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">parse_expression</span><span class="p">(</span><span class="s2">"x &gt; 5 and y == 'hello'"</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">expr</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span>
<span class="n">BoolOp</span><span class="p">(</span>
  <span class="n">op</span><span class="o">=</span><span class="n">And</span><span class="p">(),</span>
  <span class="n">values</span><span class="o">=</span><span class="p">[</span>
    <span class="n">Compare</span><span class="p">(</span>
      <span class="n">left</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
      <span class="n">ops</span><span class="o">=</span><span class="p">[</span><span class="n">Gt</span><span class="p">()],</span>
      <span class="n">comparators</span><span class="o">=</span><span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">5</span><span class="p">)]</span>
    <span class="p">),</span>
    <span class="n">Compare</span><span class="p">(</span>
      <span class="n">left</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'y'</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
      <span class="n">ops</span><span class="o">=</span><span class="p">[</span><span class="n">Eq</span><span class="p">()],</span>
      <span class="n">comparators</span><span class="o">=</span><span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">'hello'</span><span class="p">)]</span>
    <span class="p">)</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The expression object can be evaluated by passing a context (a Mapping) to
its <code class="docutils literal notranslate"><span class="pre">eval</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">expr</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="s1">'x'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">:</span> <span class="s1">'hello'</span><span class="p">})</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="kc">True</span>
</pre></div>
</div>
<p>and it can also be combined with other expressions and/or constants using
<strong>operators</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">new_expr</span> <span class="o">=</span> <span class="n">expr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># always False</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">new_expr</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="s1">'x'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">:</span> <span class="s1">'hello'</span><span class="p">})</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="kc">False</span>

<span class="n">The</span> <span class="n">following</span> <span class="n">operators</span> <span class="n">are</span> <span class="n">supported</span><span class="p">:</span>

</pre></div>
</div>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Symbol</p></th>
<th class="head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Equality</p></td>
<td><p>==</p></td>
<td><p>“active_layer_type == image”</p></td>
</tr>
<tr class="row-odd"><td><p>Inequality</p></td>
<td><p>!=</p></td>
<td><p>“active_layer_type != labels”</p></td>
</tr>
<tr class="row-even"><td><p>Or</p></td>
<td><p>|</p></td>
<td><p>“active_layer_is_rgb | all_layers_same_shape”</p></td>
</tr>
<tr class="row-odd"><td><p>And</p></td>
<td><p>&amp;</p></td>
<td><p>“active_layer_is_rgb &amp; all_layers_same_shape”</p></td>
</tr>
<tr class="row-even"><td><p>Not</p></td>
<td><p>~</p></td>
<td><p>~active_layer_is_rgb</p></td>
</tr>
<tr class="row-odd"><td><p>Greater than</p></td>
<td><p>&gt; &gt;=</p></td>
<td><p>“unselected_linked_layers &gt;= 1”</p></td>
</tr>
<tr class="row-even"><td><p>Less than</p></td>
<td><p>&lt; &lt;=</p></td>
<td><p>“layers_selection_count &lt; 2”</p></td>
</tr>
<tr class="row-odd"><td><p>Math</p></td>
<td><p>+ - * /</p></td>
<td><p>“layers_selection_count + unselected_linked_layers”</p></td>
</tr>
</tbody>
</table></div>
<div class="section" id="napari-context-keys">
<h3>napari context keys<a class="headerlink" href="#napari-context-keys" title="Permalink to this headline">¶</a></h3>
<p>To capture napari-specific conditions, napari will declare special
<strong>names</strong> that can be used in a napari expression.  Taking the example above, a
plugin might only want to provide a function if “the active layer has at least 3
dimensions”. For this, napari recognizes the name <code class="docutils literal notranslate"><span class="pre">"active_layer_ndim"</span></code> used
in an expression. In a plugin manifest, the plugin can provide a <em>when clause</em>
to enable/disable a given command:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">command</span><span class="p">:</span>
   <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myplugin.my_command</span>
   <span class="nt">when</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">active_layer_ndim &gt;= 3</span>
</pre></div>
</div>
<p>Some example context key names (currently) include:</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">layers_selection_count</span></code></p></td>
<td><p>Number of layers currently selected</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">all_layers_linked</span></code></p></td>
<td><p>True when all selected layers are linked</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">active_layer_is_rgb</span></code></p></td>
<td><p>True when the active layer is RGB</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">active_layer_type</span></code></p></td>
<td><p>Lowercase name of active layer type, or None if no layer is active.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">only_images_selected</span></code></p></td>
<td><p>True when there is at least one selected layer and all selected layers are images</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">active_layer_ndim</span></code></p></td>
<td><p>Number of dimensions in the active layer, or <code class="docutils literal notranslate"><span class="pre">None</span></code> if nothing is active</p></td>
</tr>
</tbody>
</table></div>
<p>…  many more</p>
</div>
<div class="section" id="contextkey-objects">
<h3><code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> objects<a class="headerlink" href="#contextkey-objects" title="Permalink to this headline">¶</a></h3>
<p>To track the special <strong>name</strong> strings that can be used in expressions, napari
has the <code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> class.  Instances of <code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> subclass from
<a class="reference external" href="https://docs.python.org/3/library/ast.html#ast.Name"><code class="docutils literal notranslate"><span class="pre">ast.Name</span></code></a> and represent
a variable name in an expression. Additionally, they have a <code class="docutils literal notranslate"><span class="pre">description</span></code> that
can be used in documentation, a <code class="docutils literal notranslate"><span class="pre">default_value</span></code>, and a <code class="docutils literal notranslate"><span class="pre">getter</span></code> function that
can be called to retrieve the current value (the parameters passed to the
<code class="docutils literal notranslate"><span class="pre">getter</span></code> will depend on the context key… see <a class="reference external" href="#updating-contexts">Updating
Contexts</a> below for more).</p>
<p>In order to keep related keys together, <code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> instances will usually be
declared as class attributes on a <code class="docutils literal notranslate"><span class="pre">ContextNamespace</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># all of the getters here receive an instance of viewer.layers.selection</span>

<span class="k">class</span> <span class="nc">LayerListContextKeys</span><span class="p">(</span><span class="n">ContextNamespace</span><span class="p">):</span>
    <span class="n">layers_selection_count</span> <span class="o">=</span> <span class="n">ContextKey</span><span class="p">(</span>
        <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Number of layers currently selected"</span><span class="p">,</span>
        <span class="n">getter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sel</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">active_layer_is_rgb</span> <span class="o">=</span> <span class="n">ContextKey</span><span class="p">(</span>
        <span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"True when the active layer is RGB"</span><span class="p">,</span>
        <span class="n">getter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sel</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">active</span><span class="p">,</span> <span class="s2">"rgb"</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">active_layer_ndim</span> <span class="o">=</span> <span class="n">ContextKey</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">"Number of dimensions in the active layer, or `None` if nothing is active"</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">"ndim"</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>The members of a <code class="docutils literal notranslate"><span class="pre">ContextNamespace</span></code> are static <code class="docutils literal notranslate"><span class="pre">Expr</span></code> objects.
Similar to a python <code class="docutils literal notranslate"><span class="pre">Enum</span></code>, you can see all of its members using the
<code class="docutils literal notranslate"><span class="pre">__members__</span></code> attribute on the class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">LayerListContextKeys</span><span class="o">.</span><span class="n">__members__</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">13</span><span class="p">]:</span>
<span class="n">mappingproxy</span><span class="p">({</span>
    <span class="s1">'layers_selection_count'</span><span class="p">:</span> <span class="n">ContextKey</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'layers_selection_count'</span><span class="p">),</span>
    <span class="s1">'active_layer_is_rgb'</span><span class="p">:</span> <span class="n">ContextKey</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'active_layer_is_rgb'</span><span class="p">),</span>
    <span class="s1">'active_layer_ndim'</span><span class="p">:</span> <span class="n">ContextKey</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'active_layer_ndim'</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p>A nice aspect of <code class="docutils literal notranslate"><span class="pre">ContextKeys</span></code> is that they can be used in expressions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">LayerListContextKeys</span><span class="o">.</span><span class="n">active_layer_ndim</span> <span class="o">&gt;=</span> <span class="mi">3</span> 

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">expr</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="s1">'active_layer_ndim'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="kc">False</span>
</pre></div>
</div>
<p>But unlike a simple string, they can also provide type hinting, linting
capabilities, and IDE autocompletion (for napari developers).</p>
<p><img alt="context_types" src="../_images/context_type_hint.png"/></p>
<p>A record of all registered context keys can be retrieved with the class method
<code class="docutils literal notranslate"><span class="pre">ContextKey.info()</span></code></p>
</div>
</div>
<div class="section" id="contexts">
<h2>Contexts<a class="headerlink" href="#contexts" title="Permalink to this headline">¶</a></h2>
<p>Now that we’ve seen how expression names are declared, let’s discuss the
“context” in which these expressions are evaluated.</p>
<p>As mentioned, a context is ultimately just a mapping between variable names and
their values. When evaluating a napari expression with <code class="docutils literal notranslate"><span class="pre">Expr.eval</span></code>, you can
indeed just pass a <code class="docutils literal notranslate"><span class="pre">dict</span></code> as that mapping.</p>
<p>Important objects in napari, such as the <code class="docutils literal notranslate"><span class="pre">Viewer</span></code> and the <code class="docutils literal notranslate"><span class="pre">LayerList</span></code> will be
associated with a <code class="docutils literal notranslate"><span class="pre">Context</span></code> object that tracks the value of various context
keys.  It is the job of these various objects (i.e. the <code class="docutils literal notranslate"><span class="pre">Viewer</span></code> and the
<code class="docutils literal notranslate"><span class="pre">LayerList</span></code>) to update the values in their <code class="docutils literal notranslate"><span class="pre">Contexts</span></code> when they change.
Continuing with the example above, if the user clicks on a 4-dimensional layer,
the <code class="docutils literal notranslate"><span class="pre">LayerList</span></code> would set the context key <code class="docutils literal notranslate"><span class="pre">active_layer_ndim</span></code> to <code class="docutils literal notranslate"><span class="pre">4</span></code>. napari
would then be able to enable/disable various commands and menus that required a
specific number of dimensions in the active layer.</p>
<div class="section" id="the-context-class">
<h3>The <code class="docutils literal notranslate"><span class="pre">Context</span></code> class<a class="headerlink" href="#the-context-class" title="Permalink to this headline">¶</a></h3>
<p>The napari <code class="docutils literal notranslate"><span class="pre">Context</span></code> class is a subclass of
<a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.ChainMap"><code class="docutils literal notranslate"><span class="pre">collections.ChainMap</span></code></a>
that also emits events when a key has been modified. <code class="docutils literal notranslate"><span class="pre">ChainMap</span></code> is useful here
as it allows us to have “sub-contexts” that are children of some parent context.
Child contexts can access all of the keys of the parent (but not vice-versa).
For example because a <code class="docutils literal notranslate"><span class="pre">Viewer</span></code> has a <code class="docutils literal notranslate"><span class="pre">LayerList</span></code>, all of the keys in the
<code class="docutils literal notranslate"><span class="pre">Viewer</span></code> context are available to the <code class="docutils literal notranslate"><span class="pre">LayerList</span></code> context.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">napari.utils.context</span> <span class="kn">import</span> <span class="n">get_context</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_context</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">ctx</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">Context</span><span class="p">(</span>
    <span class="p">{</span>
    <span class="s1">'layers_selection_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">'all_layers_linked'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">'unselected_linked_layers'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">'active_layer_is_rgb'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">'active_layer_type'</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">'only_images_selected'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">'only_labels_selected'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">'active_layer_ndim'</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">'active_layer_shape'</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">'active_layer_dtype'</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">'all_layers_same_shape'</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span> 
    <span class="p">{},</span>  <span class="c1"># the viewer context ... (no keys yet)</span>
    <span class="n">SettingsAwareContext</span><span class="p">({})</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The “root” context is a special <code class="docutils literal notranslate"><span class="pre">SettingsAwareContext</span></code> that can access keys in
the global <code class="docutils literal notranslate"><span class="pre">settings</span></code>.  Because contexts are <code class="docutils literal notranslate"><span class="pre">ChainMaps</span></code>, they can all access
the settings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">'settings.appearance.theme'</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="s1">'dark'</span>
</pre></div>
</div>
<p>When we evaluate an expression, we can provide it one of these context objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">LayerListContextKeys</span><span class="o">.</span><span class="n">layers_selection_count</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">expr</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-contexts">
<h3>Updating Contexts<a class="headerlink" href="#updating-contexts" title="Permalink to this headline">¶</a></h3>
<p>You may be wondering exactly how objects such as <code class="docutils literal notranslate"><span class="pre">Viewer</span></code> and <code class="docutils literal notranslate"><span class="pre">LayerList</span></code> update
the keys in their contexts. The aforementioned
<a class="reference external" href="#contextkey-objects"><code class="docutils literal notranslate"><span class="pre">ContextNamespace</span></code></a> comes into play here again.  A
<code class="docutils literal notranslate"><span class="pre">ContextNamespace</span></code> can be instantiated, and bound to a specific <code class="docutils literal notranslate"><span class="pre">Context</span></code>
instance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_context</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">llck</span> <span class="o">=</span> <span class="n">LayerListContextKeys</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</pre></div>
</div>
<p>Attributes of an instantiated <code class="docutils literal notranslate"><span class="pre">ContextNamespace</span></code> now act as getters (and
setters!) of their respective <code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> in the associated <code class="docutils literal notranslate"><span class="pre">Context</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">llck</span><span class="o">.</span><span class="n">layers_selection_count</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">'layers_selection_count'</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">update</span></code> method can be used to trigger an update of all of the
<code class="docutils literal notranslate"><span class="pre">ContextKeys</span></code> in a given <code class="docutils literal notranslate"><span class="pre">ContextNamespace</span></code> whenever a specific event occurs,
(the value is updated by passing the <code class="docutils literal notranslate"><span class="pre">event.source</span></code> to the <code class="docutils literal notranslate"><span class="pre">getter</span></code> function
that was declared in the <a class="reference external" href="#contextkey-objects"><code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> constructor</a>)</p>
<p>The following example works because <em>all</em> of the <code class="docutils literal notranslate"><span class="pre">getter</span></code> methods declared
in <code class="docutils literal notranslate"><span class="pre">LayerListContextKeys</span></code> take an instance of <code class="docutils literal notranslate"><span class="pre">layers.selection</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">llck</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_points</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Points</span> <span class="n">layer</span> <span class="s1">'Points'</span> <span class="n">at</span> <span class="mh">0x13c62b1f0</span><span class="o">&gt;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">llck</span><span class="o">.</span><span class="n">layers_selection_count</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="mi">1</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">'layers_selection_count'</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="summary-a-rough-full-picture">
<h2>Summary: A (rough) full picture<a class="headerlink" href="#summary-a-rough-full-picture" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p>napari creates special context “names” using <code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> and <code class="docutils literal notranslate"><span class="pre">ContextNamespace</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LayerListContextKeys</span><span class="p">(</span><span class="n">ContextNamespace</span><span class="p">):</span>
    <span class="n">active_layer_type</span> <span class="o">=</span> <span class="n">ContextKey</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">"Lowercase name of active layer type, or None of none active."</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">_type_string</span>
    <span class="p">)</span>
    <span class="n">active_layer_is_rgb</span> <span class="o">=</span> <span class="n">ContextKey</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">"True when the active layer is RGB"</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">active</span><span class="p">,</span> <span class="s2">"rgb"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><em>Internally</em> (in napari code), we can use those objects directly to declare
expressions in an IDE-friendly way.  For example, here we are declaratively
populating the layer-list context menu; this is a function that will split
the current stack into multiple layers, but it is only enabled when the
selected image is a (non-RGB) <code class="docutils literal notranslate"><span class="pre">Image</span></code> layer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s1">'napari:split_stack'</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">'description'</span><span class="p">:</span> <span class="n">trans</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s1">'Split Stack'</span><span class="p">),</span>
    <span class="s1">'action'</span><span class="p">:</span> <span class="n">_split_stack</span><span class="p">,</span>
    <span class="s1">'enable_when'</span><span class="p">:</span> <span class="n">LLCK</span><span class="o">.</span><span class="n">active_layer_type</span> <span class="o">==</span> <span class="s2">"image"</span><span class="p">,</span>
    <span class="s1">'show_when'</span><span class="p">:</span> <span class="o">~</span><span class="n">LLCK</span><span class="o">.</span><span class="n">active_layer_is_rgb</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p><em>Externally</em> (in plugin manifests), plugin developers use the string form to
express conditions.  For example, this plugin manifest offers up a command
(just a callable) that is only enabled when the the active layer is an RGB
image.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_plugin</span>
<span class="nt">commands</span><span class="p">:</span>
  <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_plugin.some_command</span>
  <span class="nt">when</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">active_layer_is_rgb</span>
</pre></div>
</div>
<p>When this manifest is parsed, those expressions will be converted into
napari <code class="docutils literal notranslate"><span class="pre">Expr</span></code> objects internally.</p>
</li>
<li><p>During runtime, napari maintains and <a class="reference external" href="#updating-contexts">updates contexts</a></p></li>
<li><p>As these contexts are updated, they emit events that allow menus, keybindings,
and other things to update themselves accordingly.  For example, the layer-list
context menu might update the items in the menu that are visible and/or enabled:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context_menu</span><span class="o">.</span><span class="n">update_from_context</span><span class="p">(</span><span class="n">get_context</span><span class="p">(</span><span class="n">layer_list</span><span class="p">))</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">update_from_context</span></code> is a function that takes in a <code class="docutils literal notranslate"><span class="pre">Context</span></code> and
updates all of the “action” items in the menu according to their <code class="docutils literal notranslate"><span class="pre">when</span></code>
clauses (declared internally or externally in steps 3 and 4)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># pseudocode</span>
<span class="k">def</span> <span class="nf">update_from_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">():</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">when</span>  <span class="c1"># or however you get the expression</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./guides"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../plugins/index.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Plugins</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="translations.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Translations</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2020
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../_sources/guides/contexts_expressions.md"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Contexts and Expressions in napari</a><ul>
<li><a class="reference internal" href="#python-expressions">Python expressions</a></li>
<li><a class="reference internal" href="#napari-expressions">Napari expressions</a><ul>
<li><a class="reference internal" href="#napari-context-keys">napari context keys</a></li>
<li><a class="reference internal" href="#contextkey-objects"><code class="docutils literal notranslate"><span class="pre">ContextKey</span></code> objects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contexts">Contexts</a><ul>
<li><a class="reference internal" href="#the-context-class">The <code class="docutils literal notranslate"><span class="pre">Context</span></code> class</a></li>
<li><a class="reference internal" href="#updating-contexts">Updating Contexts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary-a-rough-full-picture">Summary: A (rough) full picture</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>